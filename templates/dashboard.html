{#
DASHBOARD TEMPLATE - Main User Interface
=========================================

Purpose: Central hub displaying user stats, tasks, calendar, and quick actions

Template Inheritance: Extends layout.html for consistent navigation and styling

Backend Connection:
- Route: @app.route('/dashboard') in app.py
- Function: dashboard() returns render_template('dashboard.html', **context_data)

Data Flow:
1. Backend fetches user data from database (User, Todo, Event, PomodoroSession models)
2. Calculates stats (XP, weekly hours, completed tasks, proficiency)
3. Passes data as Jinja2 variables to this template
4. Template renders HTML with dynamic data
5. JavaScript (dashboard_calendar.js) adds interactivity
#}

{% extends "layout.html" %} {# Inherit from base layout (sidebar, header, footer) #}

{% block title %}Dashboard - StudyVerse{% endblock %} {# Set browser tab title #}

{% block content %} {# Main content area - replaces {% block content %} in layout.html #}
<div style="max-width: 1300px; margin: 0 auto; padding: 0 20px;">

    {# ========================================================================
    HERO BANNER - Video Background
    ========================================================================
    Purpose: Eye-catching welcome banner with background video
    Backend: Static video file served from static/img/bg3.mp4
    Note: Uses HTML5 video element with autoplay, loop, muted for UX
    #}
    <div class="pixel-banner"
        style="overflow: hidden; position: relative; height: 260px; border-radius: 20px; margin-bottom: 24px;">

        {# Background video - Flask url_for() generates correct static file path #}
        <video autoplay loop muted playsinline
            style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; z-index: 0;">
            <source src="{{ url_for('static', filename='img/bg3.mp4') }}" type="video/mp4">
        </video>

        {# Overlay text on top of video (z-index: 1 to appear above video) #}
        <div class="banner-overlay" style="z-index: 1;">
            <h1
                style="font-size: 2.8rem; font-family: var(--font-heading); color: #fff; margin: 0; text-shadow: 0 4px 15px rgba(0,0,0,0.7);">
                Ultimate Student Planner
            </h1>
        </div>
    </div>

    {# ========================================================================
    TOP STATS ROW - Quick Overview Cards
    ========================================================================
    Purpose: Display key metrics at a glance
    Backend Variables (from app.py dashboard() function):
    - current_user.total_xp: Total XP earned (from User model)
    - weekly_hours: Hours studied this week (calculated from PomodoroSession)
    - completed_todos: Number of completed tasks (from Todo model)
    - avg_proficiency: Average knowledge proficiency % (from Proficiency model)

    Data Flow:
    1. Backend queries database for user stats
    2. Jinja2 {{ variable }} syntax inserts values into HTML
    3. CSS classes (bento-card, glass) provide styling
    #}
    <div class="top-stats-grid"> {# Grid layout: 4 equal columns #}

        {# XP Card - Shows total experience points #}
        <div class="bento-card glass"
            style="padding: 10px; text-align: center; border-bottom: 2px solid var(--accent-green);">
            <div style="font-size: 0.55rem; color: var(--text-muted); text-transform: uppercase; font-weight: 700;">XP
            </div>
            {# Jinja2 variable: current_user is Flask-Login's current logged-in user #}
            <div style="font-size: 1.2rem; font-weight: 800; color: var(--text-primary);">{{ current_user.total_xp }}
            </div>
        </div>

        {# Study Hours Card - Weekly focus time #}
        <div class="bento-card glass" style="padding: 10px; text-align: center; border-bottom: 2px solid #60a5fa;">
            <div style="font-size: 0.55rem; color: var(--text-muted); text-transform: uppercase; font-weight: 700;">
                Hours</div>
            {# Jinja2 conditional: Show hours if > 0, otherwise show "<1h" #} <div
                style="font-size: 1.2rem; font-weight: 800; color: var(--text-primary);">{% if weekly_hours > 0 %}{{
                weekly_hours
                }}h{% else %}0h{% endif %}
        </div>
    </div>

    {# Tasks Card - Completed tasks count #}
    <div class="bento-card glass" style="padding: 10px; text-align: center; border-bottom: 2px solid #fbbf24;">
        <div style="font-size: 0.55rem; color: var(--text-muted); text-transform: uppercase; font-weight: 700;">
            Tasks</div>
        {# Jinja2 filter: 'or 0' provides default value if completed_todos is None #}
        <div style="font-size: 1.2rem; font-weight: 800; color: var(--text-primary);">{{ completed_todos or 0 }}
        </div>
    </div>

    {# Proficiency Card - Average knowledge level #}
    <div class="bento-card glass" style="padding: 10px; text-align: center; border-bottom: 2px solid #a78bfa;">
        <div style="font-size: 0.55rem; color: var(--text-muted); text-transform: uppercase; font-weight: 700;">
            Level</div>
        {# Backend calculates average proficiency from Proficiency model #}
        <div style="font-size: 1.2rem; font-weight: 800; color: var(--text-primary);">{{ avg_proficiency or 0 }}%
        </div>
    </div>

    {# Streak Card - Daily study streak #}
    <div class="bento-card glass"
        style="padding: 10px; text-align: center; border-bottom: 2px solid #f97316; position: relative; overflow: hidden;">
        <div style="font-size: 0.55rem; color: var(--text-muted); text-transform: uppercase; font-weight: 700;">
            ðŸ”¥ Streak</div>
        <div style="font-size: 1.2rem; font-weight: 800; color: #f97316;">
            {{ current_user.current_streak or 0 }}d
        </div>
        {% if current_user.current_streak and current_user.current_streak >= 3 %}
        <div style="font-size: 0.55rem; color: #f97316; opacity: 0.7; margin-top: 2px;">
            Best: {{ current_user.longest_streak or 0 }}d
        </div>
        {% endif %}
    </div>
</div>

<!-- NEW DASHBOARD GRID -->
<div class="dashboard-grid-container">

    <!-- ROW 1: CLOCK, FOCUS, IMPORTANT -->

    <!-- 1. Green Clock Card -->
    <!-- 1. Green Clock Card (Flip Style) -->
    <div class="card-clock-green">
        <div class="flip-clock">
            <!-- Hours -->
            <div class="clock-group">
                <div class="flip-digit green-tint" id="flip-h1">0</div>
                <div class="flip-digit green-tint" id="flip-h2">0</div>
            </div>
            <div class="clock-divider">:</div>
            <!-- Minutes -->
            <div class="clock-group">
                <div class="flip-digit green-tint" id="flip-m1">0</div>
                <div class="flip-digit green-tint" id="flip-m2">0</div>
            </div>
            <div class="clock-divider">:</div>
            <!-- Seconds -->
            <div class="clock-group">
                <div class="flip-digit green-tint" id="flip-s1">0</div>
                <div class="flip-digit green-tint" id="flip-s2">0</div>
            </div>
        </div>

        <div class="card-clock-date" id="clock-day">DATE</div>

        <div style="display: flex; gap: 8px; margin-top: 8px;">
            <div class="clock-ampm-badge" id="badge-am">AM</div>
            <div class="clock-ampm-badge" id="badge-pm">PM</div>
        </div>
    </div>

    <!-- 2. Productivity Chart Card (Circular 24h) -->
    <div class="card-focus-wide"
        style="display: flex; flex-direction: row; align-items: center; justify-content: space-between; gap: 20px;">
        <div style="flex: 1;">
            <div class="focus-header" style="margin-bottom: 12px;">
                <div class="focus-badge">
                    <i class="fa-solid fa-chart-pie"></i> Daily Productivity
                </div>
            </div>
            <h3 class="focus-title" style="font-size: 1.8rem; margin-bottom: 8px;">
                {{ (today_study_mins / 60)|round(1) }}<span style="font-size: 1rem; color: #888;">h</span>
            </h3>
            <p class="focus-subtitle" style="margin: 0;">of 24h Goal</p>
            <div style="margin-top: 16px; font-size: 0.8rem; color: var(--text-muted);">
                {% if today_study_mins > 0 %}
                Keep going! Every minute counts.
                {% else %}
                Start your first session today!
                {% endif %}
            </div>
        </div>

        <!-- Circular Chart -->
        <div style="width: 140px; height: 140px; position: relative; display: grid; place-items: center;">
            <svg viewBox="0 0 100 100" style="width: 100%; height: 100%; transform: rotate(-90deg);">
                <!-- Background Circle -->
                <circle cx="50" cy="50" r="45" fill="none" stroke="#222" stroke-width="8"></circle>
                <!-- Progress Circle -->
                {% set per_24h = (today_study_mins / 1440 * 100) %}
                <!-- Cap at 100% for visual sanity, though 24h study is unlikely -->
                {% if per_24h > 100 %}{% set per_24h = 100 %}{% endif %}
                <circle cx="50" cy="50" r="45" fill="none" stroke="var(--accent-green)" stroke-width="8"
                    stroke-dasharray="282.7" stroke-dashoffset="{{ 282.7 - (282.7 * (per_24h / 100)) }}"
                    stroke-linecap="round" style="transition: stroke-dashoffset 1s ease;">
                </circle>
            </svg>
            <div style="position: absolute; text-align: center;">
                <div style="font-size: 1.2rem; font-weight: 800; color: #fff;">{{ per_24h|round(1) }}%</div>
            </div>
        </div>
    </div>

    <!-- 3. Important Card (Red) -->
    <div class="card-important-red" style="height: auto; min-height: 200px;">
        <div class="important-label">
            <i class="fa-solid fa-bullhorn"></i> Important
        </div>

        {% if important_event %}
        <div class="important-item"
            style="margin-bottom: 12px; border-left-color: #fbbf24; background: rgba(251, 191, 36, 0.05);">
            <div
                style="font-size: 0.65rem; color: #fbbf24; font-weight: 800; margin-bottom: 4px; text-transform: uppercase;">
                Next Event</div>
            <div class="important-title" style="color: #fff;">{{ important_event.title }}</div>
            <div class="important-meta" style="color: #fbbf24;">{{ important_event.date }} â€¢ {{ important_event.time
                }}</div>
        </div>
        {% endif %}

        {% if important_todo %}
        {% set is_high = (important_todo_label == 'High Priority Task') %}
        {% set todo_color = '#ef4444' if is_high else '#3b82f6' %}
        <div class="important-item"
            style="border-left-color: {{ todo_color }}; {{ 'background: rgba(59, 130, 246, 0.05);' if not is_high }}">
            <div
                style="font-size: 0.65rem; color: {{ todo_color }}; font-weight: 800; margin-bottom: 4px; text-transform: uppercase;">
                {{ important_todo_label }}</div>
            <div class="important-title">{{ important_todo.title }}</div>
            <div class="important-meta" style="{{ 'color: ' + todo_color if not is_high }}">Due {{
                important_todo.due_date if important_todo.due_date else 'Soon' }}
            </div>
        </div>
        {% endif %}

        {% if not important_event and not important_todo %}
        <div class="important-item">
            <div class="important-title">All Clear!</div>
            <div class="important-meta">No urgent events or high priority tasks.</div>
        </div>
        {% endif %}
    </div>

    {# ========================================================================
    ACTIVE TASKS WIDGET
    ========================================================================
    Purpose: Display incomplete tasks for quick access
    Backend: upcoming_todos list (filtered by completed=False)
    Note: Only shows incomplete tasks, completed tasks are filtered out
    #}
    <div class="active-tasks-card">
        <div class="active-tasks-header">
            <div style="font-weight: 700; color: #fff; display: flex; align-items: center; gap: 8px;">
                <i class="fa-solid fa-list-check" style="color: #ef4444;"></i> Active Tasks
            </div>
            {# Task count badge - shows number of incomplete tasks #}
            <div class="task-count-badge">{{ upcoming_todos|length }} TASKS</div>
        </div>

        <div class="active-task-list">
            {# Loop through first 5 incomplete tasks #}
            {% for todo in upcoming_todos[:5] %}
            {# Only show if task is NOT completed #}
            {% if not todo.completed %}
            <div class="active-task-item" onclick="window.location.href='/todos'">
                <div class="task-item-left">
                    {# Color-coded priority indicator #}
                    <div
                        class="task-status-dot {% if todo.priority == 'high' %}status-dot-red{% elif todo.priority == 'medium' %}status-dot-orange{% else %}status-dot-green{% endif %}">
                    </div>
                    <div class="task-item-content">
                        <h4>{{ todo.title }}</h4>
                        {# Show due date if available, otherwise just priority #}
                        <p>
                            {% if todo.due_date %}
                            Due: {{ todo.due_date }}
                            {% else %}
                            Priority {{ todo.priority|upper }}
                            {% endif %}
                        </p>
                    </div>
                </div>
                <i class="fa-solid fa-chevron-right task-item-arrow"></i>
            </div>
            {% endif %}
            {% else %}
            {# Show message if no active tasks #}
            <div style="text-align: center; color: var(--text-muted); padding: 40px;">
                No active tasks
            </div>
            {% endfor %}
        </div>

        <button class="btn-add-new-task" onclick="window.location.href='/todos'">
            ADD NEW TASK <i class="fa-solid fa-plus"></i>
        </button>
    </div>

    <!-- 2. Temporal Grid (Calendar & Events) -->
    <div class="temporal-grid-card">
        <div class="temporal-header">
            <div><i class="fa-regular fa-calendar"></i> Temporal Grid</div>
            <div style="color: var(--destructive); opacity: 0.8;"><i class="fa-solid fa-circle"
                    style="font-size: 6px; vertical-align: middle;"></i> LIVE</div>
        </div>

        <!-- Left: Calendar Widget -->
        <div class="calendar-widget">
            <div class="cal-header">
                <button class="cal-nav-btn"><i class="fa-solid fa-chevron-left"></i></button>
                <span>January 2026</span>
                <button class="cal-nav-btn"><i class="fa-solid fa-chevron-right"></i></button>
            </div>
            <div class="cal-days-grid">
                <div class="cal-day-label">SU</div>
                <div class="cal-day-label">MO</div>
                <div class="cal-day-label">TU</div>
                <div class="cal-day-label">WE</div>
                <div class="cal-day-label">TH</div>
                <div class="cal-day-label">FR</div>
                <div class="cal-day-label">SA</div>

                <!-- Week 1 -->
                <div class="cal-day empty"></div>
                <div class="cal-day empty"></div>
                <div class="cal-day empty"></div>
                <div class="cal-day empty"></div>
                <div class="cal-day">1</div>
                <div class="cal-day">2</div>
                <div class="cal-day">3</div>

                <!-- Week 2 -->
                <div class="cal-day">4</div>
                <div class="cal-day">5</div>
                <div class="cal-day">6</div>
                <div class="cal-day">7</div>
                <div class="cal-day">8</div>
                <div class="cal-day">9</div>
                <div class="cal-day">10</div>

                <!-- Week 3 -->
                <div class="cal-day">11</div>
                <div class="cal-day">12</div>
                <div class="cal-day">13</div>
                <div class="cal-day">14</div>
                <div class="cal-day">15</div>
                <div class="cal-day">16</div>
                <div class="cal-day">17</div>

                <!-- Week 4 -->
                <div class="cal-day">18</div>
                <div class="cal-day">19</div>
                <div class="cal-day">20</div>
                <div class="cal-day">21</div>
                <div class="cal-day">22</div>
                <div class="cal-day">23</div>
                <div class="cal-day">24</div>

                <!-- Week 5 -->
                <div class="cal-day active" style="position: relative;">
                    25
                    <div
                        style="position: absolute; bottom: 4px; left: 50%; transform: translateX(-50%); width: 4px; height: 4px; background: #000; border-radius: 50%;">
                    </div>
                </div>
                <div class="cal-day">26</div>
                <div class="cal-day">27</div>
                <div class="cal-day">28</div>
                <div class="cal-day">29</div>
                <div class="cal-day">30</div>
                <div class="cal-day">31</div>
            </div>
        </div>

        <!-- Right: Event Manager -->
        <div class="events-widget">
            <div class="timeline-info">
                <i class="fa-regular fa-clock"></i> Timeline // Jan 25
            </div>

            <div id="eventListContainer" style="flex: 1; overflow-y: auto; padding-right: 5px; max-height: 250px;">
                <div class="event-placeholder" id="eventPlaceholder">
                    <i class="fa-regular fa-clock"></i>
                    <div style="font-size: 0.85rem; font-weight: 600;">Zero Collisions Detected</div>
                    <div style="font-size: 0.7rem;">No scheduled events for today</div>
                </div>
            </div>

            <button class="btn-init-event" onclick="openCreateEventModal()" style="margin-top: 12px;">
                <i class="fa-solid fa-plus"></i> Initialize Event
            </button>
        </div>
    </div>

    <!-- 3. Weekly To-Dos & Small Image -->
    <div class="card-todos-right">
        <div>
            <h3 class="weekly-todos-header">Weekly To-Dos</h3>

            <div id="weekly-todos-trigger" onclick="toggleWeeklyTodos()"
                style="font-size: 0.9rem; margin: 12px 0; color: #fff; font-weight: 700; cursor: pointer; display: flex; align-items: center; gap: 8px; user-select: none;">
                <i class="fa-solid fa-caret-down" id="todos-caret" style="transition: transform 0.3s ease;"></i>
                This Week
            </div>

            <div id="weekly-todos-content"
                style="transition: max-height 0.4s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.3s ease; overflow: hidden; max-height: 1000px;">
                <ul class="todos-list-minimal">
                    {% for todo in upcoming_todos[:3] %}
                    <li>{{ todo.title }}</li>
                    {% endfor %}

                    {% for parent in completed_parent_tasks[:2] %}
                    <li style="text-decoration: line-through; opacity: 0.7; color: var(--accent-green);">
                        <i class="fa-solid fa-check" style="margin-right: 8px; font-size: 0.7rem;"></i>
                        {{ parent }}
                    </li>
                    {% endfor %}

                    {% if not upcoming_todos and not completed_parent_tasks %}
                    <li style="color: var(--text-muted); font-style: italic; list-style: none;">No tasks organized yet.
                    </li>
                    {% endif %}
                </ul>

                {% if completed_events_week %}
                <div
                    style="font-size: 0.9rem; margin-top: 20px; margin-bottom: 12px; color: var(--accent-green); font-weight: 700;">
                    <i class="fa-solid fa-check-double"></i> Completed (Events)
                </div>
                <ul class="todos-list-minimal">
                    {% for event in completed_events_week[:3] %}
                    <li style="text-decoration: line-through; opacity: 0.7; color: var(--accent-green);">
                        <i class="fa-solid fa-check" style="margin-right: 8px; font-size: 0.7rem;"></i>
                        {{ event.title }}
                    </li>
                    {% endfor %}
                </ul>
                {% endif %}
            </div>
        </div>

        <div class="card-image-small">
            <img src="https://images.unsplash.com/photo-1456513080510-7bf3a84b82f8?auto=format&fit=crop&q=80&w=300&h=200"
                style="width: 100%; height: 100%; object-fit: cover;" alt="Book">
        </div>
    </div>

</div>

<!-- ROW 3: Banner + Weekly Stats -->
<div class="bottom-stats-grid">
    <!-- Left: Habit Tracker (Chart Only) -->
    <div class="weekly-stats-card" style="padding: 24px 24px 0 24px; display: flex; flex-direction: column;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
            <h3 style="margin: 0; font-size: 1.1rem; color: #fff; font-weight: 600;">Habit Consistency</h3>
            <div style="display: flex; align-items: center; gap: 6px; font-size: 0.75rem; color: #888;">
                <span style="width: 8px; height: 8px; background: #ef4444; border-radius: 50%;"></span>
                <span>Completion %</span>
            </div>
        </div>

        <div id="dashboard-habit-chart"
            style="flex: 1; display: flex; justify-content: space-around; align-items: flex-end; padding-bottom: 0; border-bottom: 1px solid #1a1a1a; margin-top: auto;">
            <!-- JS will populate this from LocalStorage -->
            <div style="color: var(--text-muted); align-self: center;">Loading habit data...</div>
        </div>
    </div>

    <!-- Right: Weekly Stats -->
    <div class="weekly-stats-card">
        <div class="w-stats-header">
            <div>
                <h3 style="margin: 0; font-size: 1rem; color: #fff;">Weekly Stats</h3>
            </div>
            <div style="font-size: 0.7rem; color: #888; display: flex; gap: 8px; align-items: center;">
                <span><span class="legend-dot" style="background: #ef4444;"></span> Focus Time</span>
            </div>
        </div>

        <div class="stats-row-3">
            <div class="mini-stat-box" style="background: rgba(239, 68, 68, 0.1);">
                <div class="stat-label" style="color: #ef4444;">Focus Time</div>
                <div class="stat-val">{{ weekly_stats.total_focus }} <span style="font-size: 0.7rem;">mins</span>
                </div>
            </div>
            <div class="mini-stat-box" style="background: rgba(16, 185, 129, 0.1);">
                <div class="stat-label" style="color: #10b981;">Tasks Done</div>
                <div class="stat-val">{{ weekly_stats.total_tasks }}</div>
            </div>
        </div>

        <!-- Weekly Stats Dual Chart -->
        <div class="weekly-stats-chart"
            style="display: flex; justify-content: space-around; align-items: flex-end; height: 180px; margin-top: 20px; padding: 20px 10px; gap: 8px; background: rgba(0,0,0,0.3); border-radius: 12px; border: 1px solid rgba(255,255,255,0.1);">
            {% if weekly_stats and weekly_stats.chart %}
            {% for day in weekly_stats.chart %}
            <div
                style="display: flex; flex-direction: column; align-items: center; justify-content: flex-end; flex: 1; height: 100%; gap: 8px;">
                <!-- Bars Container - Always show both bars side by side -->
                <div style="display: flex; align-items: flex-end; justify-content: center; height: 100%; gap: 6px;">
                    <!-- Red bar for focus time - Show if focus_mins > 0 -->
                    {% if day.focus_mins > 0 %}
                    <div class="stat-bar bar-focus"
                        style="height: {% if day.focus_pct > 10 %}{{ day.focus_pct }}{% else %}10{% endif %}%;">
                        <span class="bar-value">{{ day.focus_mins }}m</span>
                    </div>
                    {% else %}
                    <div style="width: 18px; height: 2%; background: transparent;"></div>
                    {% endif %}

                    <!-- Green bar for tasks - Show if task_count > 0 -->
                    {% if day.task_count > 0 %}
                    <div class="stat-bar bar-task"
                        style="height: {% if day.task_pct > 10 %}{{ day.task_pct }}{% else %}10{% endif %}%;">
                        <span class="bar-value">{{ day.task_count }}</span>
                    </div>
                    {% else %}
                    <div style="width: 18px; height: 2%; background: transparent;"></div>
                    {% endif %}
                </div>
                <!-- Day label -->
                <div style="color: #888; font-size: 0.7rem; font-weight: 700; text-transform: uppercase;">{{ day.day
                    }}</div>
            </div>
            {% endfor %}
            {% else %}
            <div style="width: 100%; text-align: center; color: #888; padding: 20px;">
                No activity data this week
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Maintain Original Globe/Stats if desired, or remove. For now, removing to match "Clean" look of reference. -->

<!-- Quick Navigation (Floating Minimal) -->
<div class="quick-nav-floating"
    style="position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); display: flex; gap: 12px; z-index: 1000; background: rgba(15,15,15,0.9); backdrop-filter: blur(20px); padding: 10px; border-radius: 18px; border: 1px solid rgba(255,255,255,0.1);">
    <a href="/pomodoro" class="btn-primary"
        style="padding: 10px 20px; text-decoration: none; border-radius: 10px; font-weight: 700; font-size: 0.8rem; background: var(--accent-green); color: #000;">Focus
        Mode</a>
    <a href="/todos" class="btn-secondary"
        style="padding: 10px 20px; text-decoration: none; border-radius: 10px; font-weight: 700; font-size: 0.8rem; background: transparent; color: #fff; border: 1px solid #444;">Tasks</a>
    <a href="/chat" class="btn-secondary"
        style="padding: 10px 20px; text-decoration: none; border-radius: 10px; font-weight: 700; font-size: 0.8rem; background: #8b5cf6; color: #fff; border: none; display: inline-block; text-align: center;">AI
        Coach</a>
</div>
</div>

<!-- AI Plan Modal (Maintain Original Logic) -->
<div id="aiPlanModal" class="modal-overlay"
    style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 2000; justify-content: center; align-items: center;">
    <div class="modal-content"
        style="background: var(--bg-card); padding: 30px; border-radius: 20px; width: 90%; max-width: 650px; border: 1px solid var(--border);">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
            <h2
                style="font-family: var(--font-heading); font-size: 1.6rem; display: flex; align-items: center; gap: 10px;">
                <i class="fa-solid fa-robot" style="color: var(--accent-green);"></i> StudyVerse AI
            </h2>
            <button onclick="document.getElementById('aiPlanModal').style.display='none'"
                style="background: none; border: none; color: #888; font-size: 1.8rem; cursor: pointer;">&times;</button>
        </div>
        <div id="aiPlanLoading" style="text-align: center; padding: 40px;">
            <div
                style="width: 50px; height: 50px; border: 4px solid rgba(74, 222, 128, 0.1); border-top-color: var(--accent-green); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px;">
            </div>
            <p style="color: var(--text-secondary);">Analyzing your progress...</p>
        </div>
        <div id="aiPlanContent"
            style="display: none; line-height: 1.7; color: var(--text-primary); max-height: 400px; overflow-y: auto;">
        </div>
        <div style="margin-top: 30px; text-align: right;">
            <button onclick="document.getElementById('aiPlanModal').style.display='none'" class="btn-primary"
                style="padding: 10px 25px; border-radius: 10px;">Got it</button>
        </div>
    </div>
</div>

<!-- Create Event Modal -->
<div id="createEventModal" class="modal-overlay"
    style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2500; justify-content: center; align-items: center; backdrop-filter: blur(5px);">
    <div class="modal-content"
        style="background: #111; padding: 30px; border-radius: 20px; width: 90%; max-width: 450px; border: 1px solid rgba(74, 222, 128, 0.3); box-shadow: 0 0 40px rgba(0,0,0,0.5);">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
            <h2 id="eventModalTitle"
                style="color: #fff; font-family: var(--font-heading); font-size: 1.5rem; margin: 0;">Initialize Event
            </h2>
            <button onclick="document.getElementById('createEventModal').style.display='none'"
                style="background: none; border: none; color: #888; font-size: 1.8rem; cursor: pointer;">&times;</button>
        </div>

        <input type="hidden" id="editEventId" value="">

        <div style="display: flex; flex-direction: column; gap: 15px;">
            <div class="form-group">
                <label
                    style="display: block; color: var(--text-secondary); margin-bottom: 8px; font-size: 0.85rem;">Event
                    Title</label>
                <input type="text" id="eventTitle" placeholder="e.g. Meeting, Study Session"
                    style="width: 100%; background: rgba(255,255,255,0.05); border: 1px solid var(--border); border-radius: 10px; padding: 12px; color: #fff; outline: none; transition: border-color 0.3s;">
            </div>

            <div class="form-group">
                <label
                    style="display: block; color: var(--text-secondary); margin-bottom: 8px; font-size: 0.85rem;">Description
                    (Optional)</label>
                <textarea id="eventDescription" placeholder="What's this event about?" rows="3"
                    style="width: 100%; background: rgba(255,255,255,0.05); border: 1px solid var(--border); border-radius: 10px; padding: 12px; color: #fff; outline: none; transition: border-color 0.3s; resize: none;"></textarea>
            </div>

            <div style="display: flex; gap: 15px;">
                <div style="flex: 2;">
                    <label
                        style="display: block; color: var(--text-secondary); margin-bottom: 8px; font-size: 0.85rem;">Time</label>
                    <input type="time" id="eventTime"
                        style="width: 100%; background: rgba(255,255,255,0.05); border: 1px solid var(--border); border-radius: 10px; padding: 12px; color: #fff; outline: none; transition: border-color 0.3s;">
                </div>
            </div>

            <div style="margin-top: 20px; display: flex; gap: 10px;">
                <button id="btnSaveEvent" onclick="saveEvent()" class="btn-primary"
                    style="flex: 1; padding: 14px; border-radius: 12px; background: var(--accent-green); color: #000; font-weight: 800; border: none; cursor: pointer; box-shadow: 0 4px 15px rgba(74, 222, 128, 0.2);">
                    Initialize Event
                </button>
                <button onclick="document.getElementById('createEventModal').style.display='none'" class="btn-secondary"
                    style="flex: 1; padding: 14px; border-radius: 12px; background: rgba(255,255,255,0.05); color: #fff; font-weight: 600; border: 1px solid var(--border); cursor: pointer;">
                    Cancel
                </button>
            </div>
        </div>
    </div>
</div>

<style>
    @keyframes spin {
        to {
            transform: rotate(360deg);
        }
    }

    input[type="time"]::-webkit-calendar-picker-indicator {
        filter: invert(1);
    }

    #aiPlanContent h3 {
        color: var(--accent-green);
        margin-top: 20px;
        font-size: 1.1rem;
    }

    @keyframes blink {

        0%,
        100% {
            opacity: 1;
        }

        50% {
            opacity: 0;
        }
    }

    #eventListContainer::-webkit-scrollbar {
        width: 4px;
    }

    #eventListContainer::-webkit-scrollbar-track {
        background: rgba(255, 255, 255, 0.02);
        border-radius: 10px;
    }

    #eventListContainer::-webkit-scrollbar-thumb {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 10px;
    }

    #eventListContainer::-webkit-scrollbar-thumb:hover {
        background: var(--accent-green);
    }

    .event-item {
        transition: all 0.3s ease;
    }

    .event-item:hover {
        background: rgba(255, 255, 255, 0.08) !important;
        transform: scale(1.01);
    }

    /* Responsive Overrides */
    .top-stats-grid {
        display: grid;
        grid-template-columns: repeat(5, 1fr);
        gap: 12px;
        margin-bottom: 20px;
    }

    .bottom-stats-grid {
        margin-top: 24px;
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 20px;
        margin-bottom: 100px;
        /* Space for floating nav */
    }

    .stat-bar {
        width: 18px;
        border-radius: 6px 6px 0 0;
        position: relative;
        transition: height 1s ease;
    }

    .bar-focus {
        background: linear-gradient(to bottom, #ef4444, #b91c1c);
        box-shadow: 0 4px 10px rgba(239, 68, 68, 0.4);
    }

    .bar-task {
        background: linear-gradient(to bottom, #4ade80, #16a34a);
        box-shadow: 0 4px 10px rgba(74, 222, 128, 0.4);
    }

    .bar-value {
        position: absolute;
        top: -24px;
        left: 50%;
        transform: translateX(-50%);
        font-size: 0.75rem;
        font-weight: 800;
        white-space: nowrap;
    }

    .bar-focus .bar-value {
        color: #ef4444;
    }

    .bar-task .bar-value {
        color: #4ade80;
    }

    .weekly-stats-chart {
        gap: 8px;
    }

    @media (max-width: 1024px) {
        .bottom-stats-grid {
            grid-template-columns: 1fr;
        }
    }

    @media (max-width: 768px) {
        .top-stats-grid {
            grid-template-columns: repeat(2, 1fr);
        }

        .dashboard-grid-container {
            grid-template-columns: 1fr !important;
            gap: 15px !important;
        }

        .card-focus-wide {
            flex-direction: column !important;
            height: auto !important;
            align-items: center !important;
            text-align: center;
            padding: 20px !important;
        }

        .pixel-banner {
            height: 160px !important;
        }

        .pixel-banner h1 {
            font-size: 1.6rem !important;
        }

        .stat-bar {
            width: 12px;
        }

        .weekly-stats-card {
            padding: 15px !important;
        }

        .weekly-stats-chart {
            padding: 15px 5px !important;
            gap: 4px !important;
            height: 160px !important;
        }

        .stats-row-3 {
            gap: 8px !important;
            grid-template-columns: 1fr 1fr !important;
        }

        .stat-val {
            font-size: 1.1rem !important;
        }

        .bar-value {
            font-size: 0.6rem;
            top: -18px;
        }

        /* Floating Nav fix for mobile */
        .quick-nav-floating {
            width: 95% !important;
            bottom: 10px !important;
            padding: 6px !important;
            gap: 8px !important;
        }

        .quick-nav-floating a {
            padding: 8px 10px !important;
            font-size: 0.65rem !important;
            flex: 1;
            text-align: center;
        }
    }
</style>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/dashboard_calendar.js') }}?v=1.0.1"></script>
<script>
    function updateFlipClock() {
        const now = new Date();
        const hours24 = now.getHours();
        const hours12 = hours24 % 12 || 12;
        const minutes = now.getMinutes();
        const seconds = now.getSeconds();
        const isPm = hours24 >= 12;
        const dayNames = ['SUNDAY', 'MONDAY', 'TUESDAY', 'WEDNESDAY', 'THURSDAY', 'FRIDAY', 'SATURDAY'];

        // Split digits
        const h1 = Math.floor(hours12 / 10);
        const h2 = hours12 % 10;
        const m1 = Math.floor(minutes / 10);
        const m2 = minutes % 10;
        const s1 = Math.floor(seconds / 10);
        const s2 = seconds % 10;

        updateDigit('flip-h1', h1);
        updateDigit('flip-h2', h2);
        updateDigit('flip-m1', m1);
        updateDigit('flip-m2', m2);
        updateDigit('flip-s1', s1);
        updateDigit('flip-s2', s2);

        // Date & AM/PM
        document.getElementById('clock-day').textContent = dayNames[now.getDay()];

        const amBadge = document.getElementById('badge-am');
        const pmBadge = document.getElementById('badge-pm');
        if (isPm) {
            pmBadge.classList.add('active');
            amBadge.classList.remove('active');
        } else {
            amBadge.classList.add('active');
            pmBadge.classList.remove('active');
        }
    }

    function updateDigit(id, newVal) {
        const el = document.getElementById(id);
        if (!el) return;
        if (el.textContent !== String(newVal)) {
            el.classList.add('flip-animate');
            setTimeout(() => {
                el.textContent = newVal;
                el.classList.remove('flip-animate');
            }, 300); // Change text halfway through animation
        }
    }

    setInterval(updateFlipClock, 1000);
    updateFlipClock();

    document.querySelector('[data-nav="dashboard"]').classList.add('active');

    function openAIPlanModal() {
        const modal = document.getElementById('aiPlanModal');
        const loading = document.getElementById('aiPlanLoading');
        const content = document.getElementById('aiPlanContent');
        modal.style.display = 'flex';
        loading.style.display = 'block';
        content.style.display = 'none';

        fetch('/api/ai/plan')
            .then(r => r.json())
            .then(data => {
                loading.style.display = 'none';
                content.style.display = 'block';
                if (data.status === 'success') {
                    content.innerHTML = typeof marked !== 'undefined' ? marked.parse(data.plan) : data.plan;
                } else {
                    content.innerHTML = `<p style="color: #f87171;">Error: ${data.message}</p>`;
                }
            })
            .catch(err => {
                loading.style.display = 'none';
                content.style.display = 'block';
                content.innerHTML = `<p style="color: #f87171;">Failed to reach AI.</p>`;
            });
    }

    function toggleWeeklyTodos() {
        const content = document.getElementById('weekly-todos-content');
        const caret = document.getElementById('todos-caret');

        if (content.style.maxHeight === '0px') {
            content.style.maxHeight = '1000px';
            content.style.opacity = '1';
            if (caret) caret.style.transform = 'rotate(0deg)';
            localStorage.setItem('weeklyTodosCollapsed', 'false');
        } else {
            content.style.maxHeight = '0px';
            content.style.opacity = '0';
            if (caret) caret.style.transform = 'rotate(-90deg)';
            localStorage.setItem('weeklyTodosCollapsed', 'true');
        }
    }

    // Initialize state on load
    document.addEventListener('DOMContentLoaded', () => {
        if (localStorage.getItem('weeklyTodosCollapsed') === 'true') {
            const content = document.getElementById('weekly-todos-content');
            const caret = document.getElementById('todos-caret');
            if (content) {
                content.style.maxHeight = '0px';
                content.style.opacity = '0';
                if (caret) caret.style.transform = 'rotate(-90deg)';
            }
        }
    });
</script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="//unpkg.com/globe.gl"></script>
<script>
    document.addEventListener('DOMContentLoaded', () => {
        try {
            const globeElem = document.getElementById('activity-globe');
            if (globeElem && typeof window.Globe === 'function') {
                const Globe = window.Globe()(globeElem)
                    .globeImageUrl('//unpkg.com/three-globe/example/img/earth-dark.jpg')
                    .pointsData([...Array(10).keys()].map(() => ({
                        lat: (Math.random() - 0.5) * 160,
                        lng: (Math.random() - 0.5) * 360,
                        size: Math.random() / 3,
                        color: ['#60a5fa', '#4ade80', '#fbbf24', '#f43f5e'][Math.floor(Math.random() * 4)]
                    })))
                    .pointAltitude('size').pointColor('color').pointRadius(0.8)
                    .backgroundColor('rgba(0,0,0,0)').width(globeElem.offsetWidth).height(globeElem.offsetHeight)
                    .showAtmosphere(true).atmosphereColor('#3b82f6').atmosphereAltitude(0.2);
                Globe.controls().autoRotate = true;
                Globe.controls().autoRotateSpeed = 1.2;
                Globe.controls().enableZoom = false;
            }
        } catch (e) {
            console.error("Globe init failed:", e);
        }

        // --- HABIT CHART SYNC (LocalStorage) ---
        try {
            renderHabitChart();
        } catch (e) {
            console.error("Habit chart render failed:", e);
        }

        // Listen for custom habitChanged event (same page/component)
        window.addEventListener('habitChanged', function (e) {
            console.log("Dashboard detected habit change via event:", e.detail);
            renderHabitChart();
        });

        // Listen for localStorage changes from other tabs/pages
        window.addEventListener('storage', function (e) {
            if (e.key && e.key.startsWith('check_')) {
                console.log("Dashboard detected habit change from another tab, refreshing chart...");
                renderHabitChart();
            }
        });

        // Also refresh periodically (every 5 seconds) to catch any missed changes
        setInterval(() => {
            renderHabitChart();
        }, 5000);
    });

    function renderHabitChart() {
        const container = document.getElementById('dashboard-habit-chart');
        if (!container) {
            console.error("Dashboard habit chart container not found!");
            return;
        }

        // Use a consistent day order: Monday to Sunday
        const dayNames = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];

        // Match Progress Tracker's default habits exactly
        const defaultHabits = [
            { id: 'h1', name: 'Reading' },
            { id: 'h2', name: 'Coding' },
            { id: 'h3', name: 'Exercise' },
            { id: 'h4', name: 'Meditate' }
        ];

        let habitList = defaultHabits;
        try {
            const stored = localStorage.getItem('StudyVerse_habits');
            const parsed = stored ? JSON.parse(stored) : null;
            if (parsed && Array.isArray(parsed) && parsed.length > 0) {
                habitList = parsed;
            }
            console.log("Dashboard - Loaded habits:", habitList);
        } catch (e) { console.error("Habit sync error:", e); }

        // Date helper - EXACT MATCH to progress.html
        function getLocalDateString(d) {
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // Get this week's dates (Mon - Sun) - EXACT MATCH to progress.html
        function getWeekDates() {
            const now = new Date();
            const day = now.getDay();
            const diff = now.getDate() - day + (day === 0 ? -6 : 1);
            const monday = new Date(now);
            monday.setDate(diff);

            const weekDates = [];
            for (let i = 0; i < 7; i++) {
                const d = new Date(monday);
                d.setDate(diff + i);
                weekDates.push(getLocalDateString(d));
            }
            return weekDates;
        }

        const weekDates = getWeekDates();
        console.log("Dashboard - Week dates:", weekDates);

        let html = '';
        let totalChecks = 0;
        let totalPossible = 0;

        for (let i = 0; i < 7; i++) {
            const dateStr = weekDates[i];

            let completed = 0;
            habitList.forEach(h => {
                const key = `check_${h.id}_${dateStr}`;
                const isChecked = localStorage.getItem(key) === 'true';

                if (isChecked) {
                    completed++;
                    totalChecks++;
                    console.log(`Dashboard - Found check: ${key}`);
                }
                totalPossible++;
            });

            const total = habitList.length;
            const pct = total > 0 ? Math.round((completed / total) * 100) : 0;
            const dayName = dayNames[i];

            // Dynamic color: Green for high consistency, Red for low
            const barColor = pct >= 50 ? 'linear-gradient(to bottom, #4ade80, #166534)' : 'linear-gradient(to bottom, #ef4444, #991b1b)';
            const shadowColor = pct >= 50 ? 'rgba(74, 222, 128, 0.2)' : 'rgba(239, 68, 68, 0.2)';

            html += `
            <div style="display: flex; flex-direction: column; align-items: center; gap: 12px; flex: 1; min-width: 0; height: 100%; justify-content: flex-end;">
                <div style="position: relative; width: 60%; max-width: 32px; height: ${Math.max(pct, 2)}%; 
                            background: ${barColor}; 
                            border-radius: 6px 6px 0 0; 
                            box-shadow: 0 4px 15px ${shadowColor}; 
                            transition: height 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);">
                    ${pct > 0 ? `<span style="position: absolute; top: -22px; left: 50%; transform: translateX(-50%); font-size: 0.7rem; color: #fff; font-weight: 800; white-space: nowrap;">${pct}%</span>` : ''}
                </div>
                <span style="color: #666; font-size: 0.7rem; font-weight: 700; text-transform: uppercase;">${dayName}</span>
            </div>`;
        }

        const totalPct = totalPossible > 0 ? Math.round((totalChecks / totalPossible) * 100) : 0;
        console.log(`Dashboard - Total: ${totalChecks}/${totalPossible} = ${totalPct}%`);

        container.innerHTML = html;
    }

    // Make renderHabitChart globally accessible for manual refresh
    window.renderHabitChart = renderHabitChart;
</script>
{% endblock %}