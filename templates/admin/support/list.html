{% extends "admin/base.html" %}
{% block title %}Support Tickets{% endblock %}
{% block page_title %}Support{% endblock %}

{% block content %}
<style>
    /* Filter tabs */
    .filter-tabs {
        display: flex;
        gap: 6px;
        background: var(--bg-card);
        border: 1px solid var(--border);
        border-radius: var(--radius-md);
        padding: 5px;
        margin-bottom: 22px;
        width: fit-content;
    }

    .filter-tab {
        padding: 8px 20px;
        border-radius: var(--radius-sm);
        font-size: 13.5px;
        font-weight: 600;
        color: var(--text-secondary);
        text-decoration: none;
        transition: var(--transition);
        white-space: nowrap;
    }

    .filter-tab:hover {
        color: var(--text-primary);
        background: var(--bg-hover);
    }

    .filter-tab.active {
        background: var(--accent-dim);
        color: var(--accent);
        border: 1px solid var(--border-glow);
    }

    /* Table */
    .support-table-wrap {
        background: var(--bg-card);
        border: 1px solid var(--border);
        border-radius: var(--radius-lg);
        overflow: hidden;
    }

    .support-table-wrap table {
        width: 100%;
        border-collapse: collapse;
    }

    .support-table-wrap thead {
        background: rgba(255, 255, 255, 0.025);
    }

    .support-table-wrap th {
        padding: 14px 20px;
        text-align: left;
        font-size: 11px;
        font-weight: 700;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 0.8px;
    }

    .support-table-wrap td {
        padding: 14px 20px;
        border-top: 1px solid var(--border);
        vertical-align: middle;
        font-size: 13.5px;
        color: var(--text-primary);
    }

    .support-table-wrap tr:hover td {
        background: rgba(74, 222, 128, 0.02);
    }

    /* Avatar + name cell */
    .user-cell {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .user-cell img {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        border: 2px solid var(--border);
    }

    .user-cell-name {
        font-size: 13.5px;
        font-weight: 600;
        color: var(--text-primary);
    }

    /* Subject */
    .subject-wrap {
        max-width: 240px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        font-weight: 600;
        color: var(--text-primary);
        font-size: 14px;
        margin-bottom: 3px;
    }

    .new-chip {
        background: rgba(239, 68, 68, 0.1);
        color: #ef4444;
        border: 1px solid rgba(239, 68, 68, 0.2);
        font-size: 10px;
        font-weight: 700;
        padding: 2px 8px;
        border-radius: 20px;
        display: inline-block;
    }

    /* Category chip */
    .cat-chip {
        background: var(--bg-card-2);
        border: 1px solid var(--border);
        color: var(--text-secondary);
        font-size: 11.5px;
        font-weight: 600;
        padding: 4px 10px;
        border-radius: 12px;
    }

    /* Status badges */
    .status-badge {
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 11px;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.3px;
        display: inline-block;
    }

    .status-open {
        background: rgba(74, 222, 128, 0.1);
        color: #4ade80;
        border: 1px solid rgba(74, 222, 128, 0.2);
    }

    .status-in_progress {
        background: rgba(59, 130, 246, 0.1);
        color: #3b82f6;
        border: 1px solid rgba(59, 130, 246, 0.2);
    }

    .status-closed {
        background: rgba(161, 161, 170, 0.08);
        color: #71717a;
        border: 1px solid rgba(161, 161, 170, 0.15);
    }

    .time-col {
        font-size: 12px;
        color: var(--text-muted);
        white-space: nowrap;
    }
</style>

<!-- Filter tabs -->
<div class="filter-tabs">
    <a href="{{ url_for('admin_support', status='open') }}"
        class="filter-tab {% if current_status == 'open' %}active{% endif %}">
        <i class="fa-solid fa-envelope-open fa-xs"></i> Open
    </a>
    <a href="{{ url_for('admin_support', status='in_progress') }}"
        class="filter-tab {% if current_status == 'in_progress' %}active{% endif %}">
        <i class="fa-solid fa-spinner fa-xs"></i> In Progress
    </a>
    <a href="{{ url_for('admin_support', status='closed') }}"
        class="filter-tab {% if current_status == 'closed' %}active{% endif %}">
        <i class="fa-solid fa-check fa-xs"></i> Closed
    </a>
    <a href="{{ url_for('admin_support', status='all') }}"
        class="filter-tab {% if not current_status or current_status == 'all' %}active{% endif %}">
        All Tickets
    </a>
</div>

<!-- Tickets table -->
<div class="support-table-wrap">
    <table>
        <thead>
            <tr>
                <th style="width:60px;">ID</th>
                <th>User</th>
                <th>Subject</th>
                <th>Category</th>
                <th>Status</th>
                <th>Updated</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody>
            {% for ticket in tickets %}
            <tr>
                <td style="font-family:'JetBrains Mono',monospace; color:var(--text-muted); font-size:12px;">#{{
                    ticket.id }}</td>
                <td>
                    <div class="user-cell">
                        <img src="{{ ticket.user.get_avatar(32) }}" alt="{{ ticket.user.first_name }}">
                        <span class="user-cell-name">{{ ticket.user.first_name }}</span>
                    </div>
                </td>
                <td>
                    <div class="subject-wrap">{{ ticket.subject }}</div>
                    {% if ticket.admin_unread_count > 0 %}
                    <span class="new-chip">{{ ticket.admin_unread_count }} new</span>
                    {% endif %}
                </td>
                <td>
                    <span class="cat-chip">{{ ticket.category|title }}</span>
                </td>
                <td>
                    <span class="status-badge status-{{ ticket.status }}">
                        {{ ticket.status|replace('_',' ')|title }}
                    </span>
                </td>
                <td class="time-col">{{ ticket.updated_at|ist_time }}</td>
                <td>
                    <a href="{{ url_for('admin_support_detail', ticket_id=ticket.id) }}"
                        class="admin-btn admin-btn-secondary" style="font-size:12.5px; padding:7px 14px;">
                        <i class="fa-solid fa-eye"></i> View
                    </a>
                </td>
            </tr>
            {% else %}
            <tr>
                <td colspan="7">
                    <div style="text-align:center; padding:60px 0; color:var(--text-muted);">
                        <i class="fa-solid fa-inbox"
                            style="font-size:36px; opacity:.3; display:block; margin-bottom:12px;"></i>
                        No tickets found for this filter
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endblock %}