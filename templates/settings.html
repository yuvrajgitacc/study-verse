{% extends "layout.html" %}

{% block title %}Settings - StudyVerse{% endblock %}

{% block content %}
<!-- Profile Hero -->
<div class="profile-hero">
    <div class="profile-cover" style="background-image: linear-gradient(135deg, #1e1e1e, #111827);"></div>
    <div class="profile-avatar-wrapper">
        <img id="profile-avatar" src="{{ current_user.get_avatar(200) }}" class="profile-avatar-main"
            alt="Profile Avatar">
        <div class="profile-info-brief">
            <h2 id="profile-name">{{ current_user.first_name }} {{ current_user.last_name }}</h2>
            <p id="profile-major">{{ current_user.email }}</p>
        </div>
        <div class="profile-actions">
            <button class="btn-primary"
                onclick="openTab('settings', document.querySelector('[data-tab-btn=\'settings\']'))">
                <i class="fa-solid fa-pen"></i> Edit Profile
            </button>
        </div>
    </div>
</div>

<!-- Stats Row -->
<div class="stats-row">
    <div class="stat-card">
        <div class="stat-icon green">
            <i class="fa-solid fa-bolt"></i>
        </div>
        <div class="stat-info">
            <div class="stat-value" id="stat-level">12</div>
            <div class="stat-label">Current Level</div>
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-icon blue">
            <i class="fa-solid fa-clock"></i>
        </div>
        <div class="stat-info">
            <div class="stat-value" id="stat-hours">342h</div>
            <div class="stat-label">Focus Time</div>
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-icon red">
            <i class="fa-solid fa-fire"></i>
        </div>
        <div class="stat-info">
            <div class="stat-value" id="stat-streak">8</div>
            <div class="stat-label">Day Streak</div>
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-icon amber">
            <i class="fa-solid fa-star"></i>
        </div>
        <div class="stat-info">
            <div class="stat-value" id="stat-xp">2,450</div>
            <div class="stat-label">Total XP</div>
        </div>
    </div>
</div>

<div class="profile-grid-main">
    <!-- Left: Content Area -->
    <div class="card">
        <div class="tab-nav">
            <div class="tab-link active" onclick="openTab('overview', this)">Overview</div>
            <div class="tab-link" onclick="openTab('activity', this)">Recent Activity</div>
            <div class="tab-link" data-tab-btn="settings" onclick="openTab('settings', this)">Settings</div>
        </div>

        <div id="tab-content">
            <!-- Overview Tab -->
            <div id="overview-tab" class="tab-pane">
                <div class="settings-form-grid">
                    <div>
                        <h3 class="mb-4">Badges & Achievements</h3>
                        <div style="display: flex; flex-direction: column; gap: 12px;">
                            <div class="badge-item">
                                <div class="badge-icon"><i class="fa-solid fa-award"></i></div>
                                <div>
                                    <div style="font-weight: 600; font-size: 0.9rem;">Early Bird</div>
                                    <div style="font-size: 0.75rem; color: var(--text-secondary);">Start 5 focus
                                        sessions before 8 AM</div>
                                </div>
                            </div>
                            <div class="badge-item">
                                <div class="badge-icon" style="background: rgba(59, 130, 246, 0.1); color: #3b82f6;"><i
                                        class="fa-solid fa-brain"></i></div>
                                <div>
                                    <div style="font-weight: 600; font-size: 0.9rem;">Deep Thinker</div>
                                    <div style="font-size: 0.75rem; color: var(--text-secondary);">Complete a 2-hour
                                        focus session</div>
                                </div>
                            </div>
                            <div class="badge-item">
                                <div class="badge-icon" style="background: rgba(245, 158, 11, 0.1); color: #f59e0b;"><i
                                        class="fa-solid fa-shield-halved"></i></div>
                                <div>
                                    <div style="font-weight: 600; font-size: 0.9rem;">Focus Warrior</div>
                                    <div style="font-size: 0.75rem; color: var(--text-secondary);">Maintain a 7-day
                                        streak</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div>
                        <h3 class="mb-4">About Me</h3>
                        <p
                            style="color: var(--text-secondary); font-size: 0.95rem; line-height: 1.6; margin-bottom: 20px;">
                            Computer Science student at University. Passionate about algorithms, UI/UX design, and
                            productivity hacks. Currently focusing on mastering Python and React.
                        </p>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <span class="badge badge-low">#coding</span>
                            <span class="badge badge-low">#algorithms</span>
                            <span class="badge badge-low">#focus</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Activity Tab (Hidden by default) -->
            <div id="activity-tab" class="tab-pane" style="display: none;">
                <div class="notification-list">
                    <div style="padding: 16px 0; border-bottom: 1px solid var(--border); display: flex; gap: 16px;">
                        <div class="stat-icon green" style="width: 40px; height: 40px; border-radius: 50%;">
                            <i class="fa-solid fa-trophy"></i>
                        </div>
                        <div>
                            <div style="font-size: 0.95rem;"><strong>You leveled up!</strong> You are now Level 12. Keep
                                focusing!</div>
                            <div style="font-size: 0.8rem; color: var(--text-secondary); margin-top: 4px;">2 hours ago
                            </div>
                        </div>
                    </div>
                    <div style="padding: 16px 0; border-bottom: 1px solid var(--border); display: flex; gap: 16px;">
                        <div class="stat-icon blue" style="width: 40px; height: 40px; border-radius: 50%;">
                            <i class="fa-solid fa-clock"></i>
                        </div>
                        <div>
                            <div style="font-size: 0.95rem;">Completed <strong>Python Learning</strong> focus session
                                (50 mins).</div>
                            <div style="font-size: 0.8rem; color: var(--text-secondary); margin-top: 4px;">4 hours ago
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Settings Tab (Hidden by default) -->
            <div id="settings-tab" class="tab-pane" style="display: none;">
                <div class="settings-group">
                    <h3 class="mb-4">Profile Information</h3>
                    <div class="settings-form-grid">
                        <div class="form-group">
                            <label class="form-label" for="firstName">First Name</label>
                            <input class="form-input" type="text" id="firstName"
                                value="{{ current_user.first_name or '' }}">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="lastName">Last Name</label>
                            <input class="form-input" type="text" id="lastName"
                                value="{{ current_user.last_name or '' }}">
                        </div>
                        <div class="form-group" style="grid-column: span 2;">
                            <label class="form-label" for="email">Email</label>
                            <input class="form-input" type="email" id="email" value="{{ current_user.email }}" disabled>
                        </div>
                    </div>

                    <button class="btn-primary mb-4">Save Changes</button>

                    <div style="border-top: 1px solid var(--border); margin: 32px 0;"></div>

                    <h3 class="mb-4">Account Preferences</h3>

                    <div class="setting-row">
                        <div class="setting-info">
                            <h4>Public Profile</h4>
                            <p>Allow friends to see your focus stats and leaderboard rank.</p>
                        </div>
                        <input type="checkbox" id="publicProfileToggle" {% if current_user.is_public_profile %}checked{%
                            endif %} style="width: 20px; height: 20px; accent-color: var(--accent-green);">
                    </div>
                    <div class="setting-row">
                        <div class="setting-info">
                            <h4>Theme</h4>
                            <p>Toggle between light and dark visual themes.</p>
                        </div>
                        <!-- Theme Toggle Button -->
                        <div style="width: 150px;">
                            <button id="theme-toggle" class="theme-toggle-btn" aria-label="Toggle theme">
                                <div style="position: relative; width: 20px; height: 20px;">
                                    <i class="fa-solid fa-sun theme-icon-light"></i>
                                    <i class="fa-solid fa-moon theme-icon-dark"></i>
                                </div>
                                <span class="theme-toggle-text">Theme</span>
                            </button>
                        </div>
                    </div>
                </div>

                <div class="danger-zone">
                    <h3><i class="fa-solid fa-triangle-exclamation"></i> Danger Zone</h3>
                    <p style="color: var(--text-secondary); margin-bottom: 20px; font-size: 0.9rem;">
                        Once you delete your account, there is no going back. Please be certain.
                    </p>
                    <a href="{{ url_for('logout') }}" class="btn-danger-outline">
                        <i class="fa-solid fa-right-from-bracket"></i> Logout
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Right: Timeline/Friends -->
    <div style="display: flex; flex-direction: column; gap: 24px;">
        <!-- Upcoming Deadlines -->
        <div class="card">
            <div class="card-header">
                <div class="card-title">Upcoming Deadlines</div>
            </div>
            <div style="display: flex; flex-direction: column; gap: 16px;">
                <div style="display: flex; gap: 12px; align-items: start;">
                    <div
                        style="background: rgba(239, 68, 68, 0.1); color: #f87171; padding: 8px 12px; border-radius: 8px; text-align: center; min-width: 50px;">
                        <div style="font-weight: 700;">20</div>
                        <div style="font-size: 0.7rem;">MAY</div>
                    </div>
                    <div>
                        <div style="font-weight: 600;">Calculus Midterm</div>
                        <div style="font-size: 0.85rem; color: var(--text-secondary);">Preparation Session</div>
                    </div>
                </div>

                <div style="display: flex; gap: 12px; align-items: start;">
                    <div
                        style="background: rgba(245, 158, 11, 0.1); color: #fbbf24; padding: 8px 12px; border-radius: 8px; text-align: center; min-width: 50px;">
                        <div style="font-weight: 700;">25</div>
                        <div style="font-size: 0.7rem;">MAY</div>
                    </div>
                    <div>
                        <div style="font-weight: 600;">History Essay</div>
                        <div style="font-size: 0.85rem; color: var(--text-secondary);">Final Submission</div>
                    </div>
                </div>
            </div>
            <button class="btn-secondary" style="width: 100%; margin-top: 20px;">View Calendar</button>
        </div>

        <!-- Focus Buddies -->
        <div class="card">
            <div class="card-header">
                <div class="card-title">Focus Buddies</div>
            </div>
            <div style="display: flex; flex-direction: column; gap: 12px;">
                {% if focus_buddies %}
                {% for buddy in focus_buddies %}
                <div style="display: flex; align-items: center; gap: 12px;">
                    <div style="position: relative;">
                        <img src="{{ buddy.avatar }}"
                            style="width: 32px; height: 32px; border-radius: 50%; border: 1px solid var(--border);">
                        {% if buddy.is_online %}
                        <div
                            style="position: absolute; bottom: 0; right: 0; width: 8px; height: 8px; background: #22c55e; border-radius: 50%; border: 1px solid var(--bg-card);">
                        </div>
                        {% endif %}
                    </div>
                    <div style="flex: 1; min-width: 0;">
                        <div
                            style="font-size: 0.9rem; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                            {{ buddy.name }}
                        </div>
                        {% if buddy.is_public and buddy.rank %}
                        <div style="font-size: 0.75rem; color: var(--text-secondary);">
                            {{ buddy.rank.name }} â€¢ Lvl {{ buddy.stats.level }}
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
                {% else %}
                <div style="color: var(--text-secondary); font-size: 0.9rem; text-align: center; padding: 20px 0;">
                    No friends yet.
                </div>
                {% endif %}
            </div>
            <a href="/friends" class="btn-secondary"
                style="margin-top: 20px; width: 100%; display: block; text-align: center; text-decoration: none;">Find
                Friends</a>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Tab Switching Logic
    function openTab(tabName, btn) {
        // Hide all tabs
        document.querySelectorAll('.tab-pane').forEach(el => {
            el.style.display = 'none';
            el.classList.remove('active-tab-animation');
        });

        // Deactivate all buttons
        document.querySelectorAll('.tab-link').forEach(el => el.classList.remove('active'));

        // Show target tab
        const targetTab = document.getElementById(tabName + '-tab');
        targetTab.style.display = 'block';

        // Add animation class
        targetTab.classList.add('active-tab-animation');

        // Activate button
        btn.classList.add('active');
    }

    // Set initial active tab
    document.addEventListener('DOMContentLoaded', () => {
        // Handle public profile toggle
        const publicProfileToggle = document.getElementById('publicProfileToggle');
        if (publicProfileToggle) {
            publicProfileToggle.addEventListener('change', (e) => {
                fetch('/settings/public-profile', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ is_public: e.target.checked })
                })
                    .then(res => res.json())
                    .then(data => {
                        if (data.status !== 'success') {
                            // Revert if failed
                            e.target.checked = !e.target.checked;
                            alert('Failed to update setting');
                        }
                    });
            });
        }

        // Theme toggle logic (reuse existing logic from layout if consistent, or add here)
        const themeBtn = document.getElementById('theme-toggle');
        if (themeBtn) {
            themeBtn.addEventListener('click', () => {
                themeBtn.classList.add('switching');
                setTimeout(() => themeBtn.classList.remove('switching'), 500);

                const currentTheme = document.documentElement.getAttribute('data-theme');
                const newTheme = currentTheme === 'light' ? 'dark' : 'light';

                document.documentElement.setAttribute('data-theme', newTheme);
                localStorage.setItem('theme', newTheme);
            });
        }
    });
</script>

<style>
    /* Small local animation for tab switching if not in global css */
    .active-tab-animation {
        animation: fadeIn 0.4s ease-out;
    }
</style>
{% endblock %}