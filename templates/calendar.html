{% extends "layout.html" %}

{% block title %}Calendar - StudyVerse{% endblock %}

{% block content %}
<div style="padding: 24px;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
        <h2 style="color: var(--text-primary); font-family: var(--font-heading);">My Calendar</h2>
        <a href="{{ url_for('profile', user_id=current_user.id) }}" class="btn"
            style="background: transparent; border: 1px solid var(--border); color: var(--text-secondary); padding: 8px 16px; border-radius: 8px; text-decoration: none;">
            <i class="fa-solid fa-arrow-left"></i> Back to Profile
        </a>
    </div>

    <div class="card" style="padding: 32px; min-height: 600px;">

        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
            <h3 id="cal-month-year" style="font-size: 1.5rem; color: var(--text-primary);">Month Year</h3>
            <div style="display: flex; gap: 8px;">
                <button onclick="changeMonth(-1)"
                    style="background: transparent; border: 1px solid var(--border); color: var(--text-primary); padding: 8px 12px; border-radius: 8px; cursor: pointer;">
                    <i class="fa-solid fa-chevron-left"></i> Prev
                </button>
                <button onclick="changeMonth(1)"
                    style="background: transparent; border: 1px solid var(--border); color: var(--text-primary); padding: 8px 12px; border-radius: 8px; cursor: pointer;">
                    Next <i class="fa-solid fa-chevron-right"></i>
                </button>
            </div>
        </div>

        <!-- Calendar Days Header -->
        <div
            style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; margin-bottom: 8px; text-align: center;">
            <div style="color: var(--text-secondary); font-size: 0.9rem; font-weight: 600;">SUN</div>
            <div style="color: var(--text-secondary); font-size: 0.9rem; font-weight: 600;">MON</div>
            <div style="color: var(--text-secondary); font-size: 0.9rem; font-weight: 600;">TUE</div>
            <div style="color: var(--text-secondary); font-size: 0.9rem; font-weight: 600;">WED</div>
            <div style="color: var(--text-secondary); font-size: 0.9rem; font-weight: 600;">THU</div>
            <div style="color: var(--text-secondary); font-size: 0.9rem; font-weight: 600;">FRI</div>
            <div style="color: var(--text-secondary); font-size: 0.9rem; font-weight: 600;">SAT</div>
        </div>

        <!-- Calendar Grid -->
        <div id="calendar-days"
            style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; grid-auto-rows: 100px;">
            <!-- Days injected via JS -->
        </div>

    </div>
</div>

<!-- Quick Add Task Modal -->
<div id="quickAddModal"
    style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 1100; place-items: center;">
    <div
        style="background: #1a1a1a; padding: 24px; border-radius: 16px; width: 100%; max-width: 400px; border: 1px solid var(--border); box-shadow: 0 4px 20px rgba(0,0,0,0.5);">

        <h3 id="quick-add-title" style="font-size: 1.2rem; color: white; margin-bottom: 16px;">Add Task</h3>

        <form action="{{ url_for('todos_add') }}" method="POST"
            style="display: flex; flex-direction: column; gap: 16px;">
            <input type="hidden" name="due_date" id="quick-due-date">
            <input type="hidden" name="next" value="{{ request.url }}"> <!-- Redirect back here -->

            <div>
                <label style="display: block; margin-bottom: 8px; font-size: 0.9rem; color: var(--text-secondary);">Task
                    Title</label>
                <input type="text" name="title" required placeholder="Ex: Math Homework"
                    style="width: 100%; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid var(--border); border-radius: 8px; color: white;">
            </div>

            <div>
                <label
                    style="display: block; margin-bottom: 8px; font-size: 0.9rem; color: var(--text-secondary);">Category</label>
                <select name="category"
                    style="width: 100%; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid var(--border); border-radius: 8px; color: white; -webkit-appearance: none; appearance: none;">
                    <option value="General" selected style="background: #1a1a1a; color: white;">General</option>
                    <option value="Personal" style="background: #1a1a1a; color: white;">Personal</option>
                    <option value="Study" style="background: #1a1a1a; color: white;">Study</option>
                    <option value="Work" style="background: #1a1a1a; color: white;">Work</option>
                </select>
            </div>

            <div>
                <label
                    style="display: block; margin-bottom: 8px; font-size: 0.9rem; color: var(--text-secondary);">Priority</label>
                <select name="priority"
                    style="width: 100%; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid var(--border); border-radius: 8px; color: white; appearance: none; -webkit-appearance: none;">
                    <option value="low" style="background: #1a1a1a; color: white;">Low</option>
                    <option value="medium" selected style="background: #1a1a1a; color: white;">Medium</option>
                    <option value="high" style="background: #1a1a1a; color: white;">High</option>
                </select>
            </div>

            <div style="display: flex; justify-content: flex-end; gap: 12px; margin-top: 8px;">
                <button type="button" onclick="closeQuickAddModal()"
                    style="padding: 10px 24px; border-radius: 12px; background: transparent; border: 1px solid var(--border); color: var(--text-secondary); cursor: pointer;">
                    Cancel
                </button>
                <button type="submit" class="btn-primary"
                    style="padding: 10px 24px; border-radius: 12px; background: var(--accent-green); color: black; border: none; font-weight: 600; cursor: pointer;">Add
                    Task</button>
            </div>
        </form>
    </div>
</div>

<!-- Task Details Modal (Reused for Calendar Interaction) -->
<div id="taskDetailsModal"
    style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 1200; place-items: center;">
    <div
        style="background: #1a1a1a; padding: 24px; border-radius: 16px; width: 100%; max-width: 400px; border: 1px solid var(--border); box-shadow: 0 4px 20px rgba(0,0,0,0.5);">
        <h3 id="detail-task-title" style="font-size: 1.2rem; color: white; margin-bottom: 24px;">Task Title</h3>

        <div style="margin-bottom: 24px; color: var(--text-secondary);">
            <p><strong>Category:</strong> <span id="detail-task-category"></span></p>
            <p><strong>Due:</strong> <span id="detail-task-date"></span></p>
            <p><strong>Priority:</strong> <span id="detail-task-priority"></span></p>
        </div>

        <div style="display: flex; gap: 12px;">
            <form id="form-delete" method="POST" style="flex: 1;" onsubmit="return confirm('Delete this task?');">
                <input type="hidden" name="next" value="{{ request.url }}">
                <button type="submit" class="btn"
                    style="width: 100%; border-radius: 12px; background: rgba(239, 68, 68, 0.1); color: #ef4444; border: 1px solid rgba(239, 68, 68, 0.2); padding: 10px; cursor: pointer;">
                    <i class="fa-solid fa-trash"></i> Delete
                </button>
            </form>

            <button onclick="closeTaskDetailsModal()"
                style="flex: 1; padding: 10px; background: transparent; border: 1px solid var(--border); color: white; cursor: pointer; border-radius: 12px;">
                Close
            </button>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    // Calendar Logic
    const calendarData = [
        {% for event in calendar_events %}
    {
        id: {{ event.id }},
        title: {{ event.title | tojson }},
        date: {{ event.due_date | tojson }},
        category: {{ event.category | tojson }},
        completed: {{ 'true' if event.completed else 'false' }},
        priority: {{ event.priority | tojson }}
    } {% if not loop.last %}, {% endif %}
    {% endfor %}
    ];

    let currentConfig = {
        month: new Date().getMonth(),
        year: new Date().getFullYear()
    };

    // Initialize
    document.addEventListener('DOMContentLoaded', function () {
        renderCalendar(currentConfig.month, currentConfig.year);
    });

    function changeMonth(offset) {
        currentConfig.month += offset;
        if (currentConfig.month < 0) {
            currentConfig.month = 11;
            currentConfig.year--;
        } else if (currentConfig.month > 11) {
            currentConfig.month = 0;
            currentConfig.year++;
        }
        renderCalendar(currentConfig.month, currentConfig.year);
    }

    function renderCalendar(month, year) {
        const calGrid = document.getElementById('calendar-days');
        const monthYearLabel = document.getElementById('cal-month-year');
        if (!calGrid || !monthYearLabel) return;

        calGrid.innerHTML = '';

        const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
        monthYearLabel.textContent = `${monthNames[month]} ${year}`;

        const firstDay = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();

        // Empty slots
        for (let i = 0; i < firstDay; i++) {
            const emptyCell = document.createElement('div');
            calGrid.appendChild(emptyCell);
        }

        // Days
        for (let day = 1; day <= daysInMonth; day++) {
            const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
            const cell = document.createElement('div');
            cell.className = 'calendar-cell'; // Use class defined in CSS

            // Highlight today
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const cellDate = new Date(year, month, day);

            if (cellDate < today) {
                cell.classList.add('past-day');
                cell.style.opacity = '0.3';
                cell.style.cursor = 'not-allowed';
            } else {
                // Add Click Handler for Adding Task
                cell.onclick = () => {
                    openQuickAddModal(dateStr);
                };
            }

            if (day === today.getDate() && month === today.getMonth() && year === today.getFullYear()) {
                cell.classList.add('today');
            }

            const dayNum = document.createElement('div');
            dayNum.textContent = day;
            dayNum.style.fontSize = '0.9rem';
            dayNum.style.color = 'var(--text-secondary)';
            dayNum.style.fontWeight = '600';
            dayNum.style.marginBottom = '4px';
            cell.appendChild(dayNum);

            // Events
            const dayEvents = calendarData.filter(e => e.date === dateStr);
            dayEvents.forEach(evt => {
                const dot = document.createElement('div');
                dot.textContent = evt.title;
                dot.className = 'event-dot';
                if (evt.priority === 'high') {
                    dot.classList.add('high');
                }

                dot.title = evt.title;

                dot.onclick = (e) => {
                    e.stopPropagation();
                    openTaskDetailsModal(evt);
                };

                cell.appendChild(dot);
            });

            calGrid.appendChild(cell);
        }
    }

    function openTaskDetailsModal(event) {
        document.getElementById('detail-task-title').innerText = event.title;
        document.getElementById('detail-task-category').innerText = event.category || 'General';
        document.getElementById('detail-task-date').innerText = event.date;
        document.getElementById('detail-task-priority').innerText = event.priority || 'Medium';

        // Set delete action
        const deleteForm = document.getElementById('form-delete');
        deleteForm.action = `/todos/delete/${event.id}`;

        document.getElementById('taskDetailsModal').style.display = 'grid';
    }

    function closeTaskDetailsModal() {
        document.getElementById('taskDetailsModal').style.display = 'none';
    }

    function openQuickAddModal(dateStr) {
        document.getElementById('quick-due-date').value = dateStr;
        document.getElementById('quick-add-title').innerText = `Add Task for ${dateStr}`;
        document.getElementById('quickAddModal').style.display = 'grid';

        // Focus title input
        setTimeout(() => {
            document.querySelector('#quickAddModal input[name="title"]').focus();
        }, 100);
    }

    function closeQuickAddModal() {
        document.getElementById('quickAddModal').style.display = 'none';
    }

    // Close on outside click
    document.getElementById('taskDetailsModal').addEventListener('click', (e) => {
        if (e.target.id === 'taskDetailsModal') closeTaskDetailsModal();
    });

    document.getElementById('quickAddModal').addEventListener('click', (e) => {
        if (e.target.id === 'quickAddModal') closeQuickAddModal();
    });
</script>
{% endblock %}