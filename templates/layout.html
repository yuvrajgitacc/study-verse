<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}StudyVerse{% endblock %}</title>

    <!-- Preconnect for performance -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://cdnjs.cloudflare.com">
    <link rel="preconnect" href="https://cdn.jsdelivr.net">

    <!-- Fonts - Moved from CSS @import for parallel loading -->
    <link
        href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;700&display=swap"
        rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500&display=swap" rel="stylesheet">

    <!-- Stylesheets -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}?v=1.0.9">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/zen_mode.css') }}?v=1.0.1">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/secretary.css') }}?v=1.0.0">
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='img/favicon.png') }}">
</head>

<body class="{{ active_theme if active_theme }}">
    <div class="app-container">
        <!-- Mobile Header / Burger -->
        <div class="mobile-header">
            <button id="sidebar-toggle" class="sidebar-toggle">
                <i class="fa-solid fa-bars"></i>
            </button>
            <div class="logo-mobile">
                <i class="fa-solid fa-graduation-cap"></i>
                <span>StudyVerse</span>
            </div>
        </div>

        <!-- Sidebar -->
        <aside class="sidebar" id="app-sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <i class="fa-solid fa-graduation-cap"></i>
                    <span>StudyVerse</span>
                </div>
                <button id="desktop-sidebar-toggle" class="desktop-sidebar-toggle">
                    <i class="fa-solid fa-chevron-left"></i>
                </button>
            </div>

            <nav class="nav-menu">
                <a href="/dashboard" class="nav-item" data-nav="dashboard" title="Dashboard">
                    <i class="fa-solid fa-grid-2"></i>
                    <span>Dashboard</span>
                </a>
                <a href="/pomodoro" class="nav-item" data-nav="pomodoro" title="Focus Mode">
                    <i class="fa-solid fa-clock"></i>
                    <span>Focus Mode</span>
                </a>
                <a href="/todos" class="nav-item" data-nav="todos" title="Task Manager">
                    <i class="fa-solid fa-list-check"></i>
                    <span>Task Manager</span>
                </a>
                <a href="/quiz" class="nav-item" data-nav="quiz" title="Start Quiz">
                    <i class="fa-solid fa-brain"></i>
                    <span>Start Quiz</span>
                </a>
                <a href="/syllabus" class="nav-item" data-nav="syllabus" title="Syllabus">
                    <i class="fa-solid fa-book"></i>
                    <span>Syllabus</span>
                </a>
                <a href="/topic-resolver" class="nav-item" data-nav="resolver" title="AI Topic Resolver"
                    style="position:relative;">
                    <i class="fa-solid fa-wand-magic-sparkles"></i>
                    <span>Topic Resolver</span>
                    <span
                        style="position:absolute; top:6px; right:8px; background:linear-gradient(135deg,#7c3aed,#4f46e5); color:white; font-size:9px; font-weight:800; padding:1px 5px; border-radius:6px; letter-spacing:0.3px;">AI</span>
                </a>
                <a href="/photo-solver" class="nav-item" data-nav="photo-solver" title="AI Photo Solver"
                    style="position:relative;">
                    <i class="fa-solid fa-camera"></i>
                    <span>Photo Solver</span>
                    <span
                        style="position:absolute; top:6px; right:8px; background:linear-gradient(135deg,#ea580c,#f97316); color:white; font-size:9px; font-weight:800; padding:1px 5px; border-radius:6px; letter-spacing:0.3px;">AI</span>
                </a>
                <a href="/progress" class="nav-item" data-nav="progress" title="Progress Tracker">
                    <i class="fa-solid fa-chart-line"></i>
                    <span>Progress Tracker</span>
                </a>
                <a href="/friends" class="nav-item" data-nav="group" title="Friends">
                    <i class="fa-solid fa-user-group"></i>
                    <span>Friends</span>
                </a>
                <a href="/live" class="nav-item" data-nav="live" title="Live Study Streams" style="position:relative;">
                    <i class="fa-solid fa-satellite-dish"></i>
                    <span>Live Streams</span>
                    <span
                        style="position:absolute; top:6px; right:8px; background:#ef4444; color:white; font-size:9px; font-weight:800; padding:1px 5px; border-radius:6px; letter-spacing:0.3px;">LIVE</span>
                </a>
                <a href="/battle" class="nav-item" data-nav="battle" title="Byte Battle">
                    <i class="fa-solid fa-code"></i>
                    <span>Byte Battle</span>
                </a>
                <a href="/chat" class="nav-item" data-nav="chat" title="AI Coach">
                    <i class="fa-solid fa-robot"></i>
                    <span>AI Coach</span>
                </a>
                <a href="/shop" class="nav-item" data-nav="shop" title="Item Shop">
                    <i class="fa-solid fa-store"></i>
                    <span>Item Shop</span>
                </a>
                <a href="/leaderboard" class="nav-item" data-nav="leaderboard" title="Leaderboard">
                    <i class="fa-solid fa-trophy"></i>
                    <span>Leaderboard</span>
                </a>
                <a href="/support" class="nav-item" data-nav="support" title="Support Center">
                    <i class="fa-solid fa-headset"></i>
                    <span>Support Center</span>
                    {% if unread_support_count > 0 %}
                    <span
                        style="background: var(--destructive); color: white; border-radius: 50%; padding: 2px 6px; font-size: 0.7rem; font-weight: 700; margin-left: auto;">{{
                        unread_support_count }}</span>
                    {% endif %}
                </a>
                <a href="#" class="nav-item" onclick="window.toggleZenMode(); return false;" id="zen-mode-nav-btn"
                    title="Zen Mode">
                    <i class="fa-solid fa-wind"></i>
                    <span>Zen Mode</span>
                </a>
                <a href="#" class="nav-item" onclick="openReferralModal(); return false;" title="Invite Friends">
                    <i class="fa-solid fa-gift"></i>
                    <span>Invite & Earn</span>
                </a>
            </nav>
            <div style="margin-top: auto;">
                {% if current_user.is_authenticated %}
                {% if current_user.is_authenticated %}
                <div style="margin-bottom: 12px;">
                    <a href="/settings"
                        style="display: block; text-decoration: none; color: inherit; padding: 12px; border-radius: 12px;">
                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                            <div class="avatar-wrapper"
                                style="position: relative; width: 32px; height: 32px; flex-shrink: 0;">
                                <img src="{{ current_user.get_avatar(64) }}"
                                    style="width: 100%; height: 100%; border-radius: 50%; display: block;">
                                {% if current_user.active_frame_color %}
                                <div
                                    style="position: absolute; inset: -3px; border-radius: 50%; border: 2px solid {{ current_user.active_frame_color }}; pointer-events: none;">
                                </div>
                                {% endif %}
                            </div>
                            <div style="flex: 1; min-width: 0;">
                                <div
                                    style="font-size: 0.9rem; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                                    {{ current_user.first_name }}</div>
                                <div class="rank-text" data-rank="{{ rank_name }}"
                                    style="font-size: 0.75rem; color: {{ rank_color }}; display: flex; align-items: center; gap: 4px;">
                                    <i class="fa-solid {{ rank_icon }}"></i> {{ rank_name }}
                                </div>
                            </div>
                        </div>
                    </a>

                    <!-- XP Bar (Separate to avoid nested links if needed, but here sticking to layout) -->
                    <!-- Note: onclick on XP bar might conflict if inside A tag, but here I moved the container div to be the wrapper of the A tag, wait. 
                         The goal is to make the "M" clickable. The previous structure had the XP bar inside the same card. 
                         I will keep the card look but make the profile section clickable separately or the whole thing. 
                         Let's keep the XP bar outside the link to avoid confusion, or make the top part a link. -->

                    <div class="xp-progress-container" title="Level {{ current_user.level }}"
                        style="cursor: pointer; margin-top: -4px; background: rgba(255,255,255,0.03); border-radius: 0 0 12px 12px; padding: 0 12px 12px 12px;"
                        onclick="showXPModal({{ current_user.level }}, {{ xp_remaining }}, {{ level_progress }})">
                        <div
                            style="display: flex; justify-content: space-between; font-size: 0.7rem; color: var(--text-secondary); margin-bottom: 4px;">
                            <span
                                style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis; flex: 1; min-width: 0;">Lvl
                                {{ current_user.level }}</span>
                            <span style="flex-shrink: 0;">{{ level_progress }}%</span>
                        </div>
                        <div class="xp-bar-bg">
                            <div class="xp-bar-fill" style="width: {{ level_progress }}%;"></div>
                        </div>
                    </div>
                </div>
                {% endif %}
                {% endif %}

                <!-- Theme Toggle Button -->
                <button id="theme-toggle" class="theme-toggle-btn" title="Toggle Theme">
                    <i class="fa-solid fa-sun theme-icon-light"></i>
                    <i class="fa-solid fa-moon theme-icon-dark"></i>
                    <span class="theme-toggle-text">Theme</span>
                </button>

                <a href="/settings" class="nav-item" data-nav="settings" title="Settings">
                    <i class="fa-solid fa-user-circle"></i>
                    <span>Settings</span>
                </a>

                <a href="/logout" class="nav-item" style="color: var(--destructive);" title="Logout">
                    <i class="fa-solid fa-right-from-bracket"></i>
                    <span>Logout</span>
                </a>
            </div>
        </aside>

        <!-- Flash Messages -->
        {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
        <div id="flash-container"
            style="position: fixed; top: 20px; right: 20px; z-index: 9999; display: flex; flex-direction: column; gap: 10px;">
            {% for category, message in messages %}
            <div class="flash-message"
                style="background: {{ 'var(--accent-green)' if category == 'success' else 'var(--destructive)' }}; color: {{ 'black' if category == 'success' else 'white' }}; padding: 12px 24px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); display: flex; align-items: center; gap: 12px; animation: slideIn 0.3s ease-out; font-weight: 500;">
                <i class="fa-solid {{ 'fa-check-circle' if category == 'success' else 'fa-circle-exclamation' }}"></i>
                <span>{{ message }}</span>
                <button onclick="this.parentElement.remove()"
                    style="background: transparent; border: none; color: inherit; cursor: pointer; margin-left: 8px; opacity: 0.7;"><i
                        class="fa-solid fa-xmark"></i></button>
            </div>
            {% endfor %}
        </div>
        <script>
            setTimeout(() => {
                const flashes = document.querySelectorAll('.flash-message');
                flashes.forEach(f => {
                    f.style.opacity = '0';
                    f.style.transform = 'translateX(20px)';
                    f.style.transition = 'all 0.3s';
                    setTimeout(() => f.remove(), 300);
                });
            }, 4000);
        </script>
        <style>
            @keyframes slideIn {
                from {
                    transform: translateX(100%);
                    opacity: 0;
                }

                to {
                    transform: translateX(0);
                    opacity: 1;
                }
            }
        </style>
        {% endif %}
        {% endwith %}

        <!-- Main Content -->
        <main class="main-content" id="main-content-area">
            {% block content %}{% endblock %}
        </main>

        <!-- Battle Byte Placeholder (Hidden by default) -->
        <main class="main-content" id="battle-content-area" style="display: none; flex-direction: column;">
            <div class="page-header"
                style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                <h1 class="page-title">Battle Byte Arena</h1>
                <div style="display: flex; gap: 16px; align-items: center;">
                    <div
                        style="background: rgba(239, 68, 68, 0.2); color: var(--destructive); padding: 8px 16px; border-radius: 20px; font-weight: 600; animation: pulse 2s infinite;">
                        <i class="fa-solid fa-circle"></i> LIVE MATCH
                    </div>
                    <button onclick="alert('AI Coach not connected in UI demo mode.')"
                        style="background: linear-gradient(135deg, #3b82f6, #8b5cf6); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; box-shadow: 0 0 15px rgba(59, 130, 246, 0.4);">
                        <i class="fa-solid fa-robot"></i> Ask AI Coach
                    </button>
                </div>
            </div>

            <!-- Arena Grid -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px; flex: 1; min-height: 0;">

                <!-- Player 1 (You) -->
                <div class="card"
                    style="display: flex; flex-direction: column; padding: 0; border: 1px solid var(--accent-green);">
                    <div
                        style="padding: 12px 16px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; background: rgba(74, 222, 128, 0.05);">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <img src="{{ current_user.get_avatar(64) }}"
                                style="width: 24px; height: 24px; border-radius: 50%;">
                            <span style="font-weight: 600; color: var(--accent-green);">YOU</span>
                        </div>
                        <div style="font-family: var(--font-mono); font-size: 0.9rem;">Python 3.10</div>
                    </div>

                    <!-- Code Editor Mock -->
                    <div
                        style="flex: 1; opacity: 0.9; background: #1e1e1e; padding: 16px; font-family: 'Fira Code', monospace; font-size: 0.9rem; line-height: 1.6; color: #d4d4d4; overflow-y: auto;">
                        <span style="color: #c586c0;">def</span> <span style="color: #dcdcaa;">solve</span>(arr):<br>
                        &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #6a9955;"># Your code here</span><br>
                        &nbsp;&nbsp;&nbsp;&nbsp;n = <span style="color: #dcdcaa;">len</span>(arr)<br>
                        &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #c586c0;">for</span> i <span
                            style="color: #c586c0;">in</span> <span style="color: #dcdcaa;">range</span>(n):<br>
                        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #c586c0;">if</span> arr[i]
                        == <span style="color: #b5cea8;">0</span>:<br>
                        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span
                            style="color: #c586c0;">return</span> i<br>
                        &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #c586c0;">return</span> -<span
                            style="color: #b5cea8;">1</span><br>
                        <br>
                        <span style="color: #6a9955;"># Write an O(n) solution</span>
                    </div>

                    <div
                        style="padding: 12px; border-top: 1px solid var(--border); display: flex; justify-content: space-between;">
                        <button
                            style="background: transparent; color: var(--text-secondary); border: 1px solid var(--border); padding: 8px 16px; border-radius: 6px; cursor: pointer;">Run
                            Code</button>
                        <button
                            style="background: var(--accent-green); color: black; border: none; padding: 8px 16px; border-radius: 6px; font-weight: 600; cursor: pointer;">Submit</button>
                    </div>
                </div>

                <!-- Player 2 (Opponent) -->
                <div class="card" style="display: flex; flex-direction: column; padding: 0;">
                    <div
                        style="padding: 12px 16px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; background: rgba(239, 68, 68, 0.05);">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <img src="https://ui-avatars.com/api/?name=Opponent&background=ef4444&color=fff"
                                style="width: 24px; height: 24px; border-radius: 50%;">
                            <span style="font-weight: 600; color: var(--destructive);">OPPONENT</span>
                        </div>
                        <div style="font-size: 0.8rem; color: var(--text-secondary);">Typing...</div>
                    </div>

                    <!-- Code Editor Mock (Blurred/Obscured) -->
                    <div
                        style="flex: 1; background: #1e1e1e; padding: 16px; font-family: 'Fira Code', monospace; font-size: 0.9rem; line-height: 1.6; color: #555; overflow-y: hidden; position: relative;">
                        <div style="filter: blur(4px);">
                            def solve(arr):<br>
                            &nbsp;&nbsp;&nbsp;&nbsp;count = 0<br>
                            &nbsp;&nbsp;&nbsp;&nbsp;x = []<br>
                            &nbsp;&nbsp;&nbsp;&nbsp;for item in arr:<br>
                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;x.append(item)<br>
                            &nbsp;&nbsp;&nbsp;&nbsp;return x
                        </div>
                        <div
                            style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: var(--text-secondary); font-weight: 500;">
                            HIDDEN
                        </div>
                    </div>

                    <div
                        style="padding: 12px; border-top: 1px solid var(--border); text-align: center; color: var(--text-secondary); font-size: 0.9rem;">
                        Waiting for submission...
                    </div>
                </div>

            </div>

            <!-- Problem Description (Bottom) -->
            <div class="card" style="margin-top: 24px; height: 150px; overflow-y: auto;">
                <h3 style="color: var(--text-primary); font-size: 1rem; margin-bottom: 8px;">Problem: Zero Hunter</h3>
                <p style="color: var(--text-secondary); font-size: 0.9rem;">
                    Given an integer array <code>nums</code>, find the index of the first occurrence of the number
                    <code>0</code>. If it does not exist, return <code>-1</code>.
                    <br><br>
                    <strong>Example:</strong> Input: <code>[1, 5, 0, 3]</code> -> Output: <code>2</code>
                </p>
            </div>
        </main>
    </div>

    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
    <script>
        function toggleBattleMode(e) {
            e.preventDefault();
            // Hide main content
            document.getElementById('main-content-area').style.display = 'none';
            // Show battle content
            document.getElementById('battle-content-area').style.display = 'flex';

            // Update active state
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.getElementById('battle-nav-link').classList.add('active');
        }

        // Sidebar Toggle Logic
        document.addEventListener('DOMContentLoaded', () => {
            const toggleBtn = document.getElementById('sidebar-toggle'); // Mobile
            const desktopToggleBtn = document.getElementById('desktop-sidebar-toggle'); // Desktop
            const sidebar = document.getElementById('app-sidebar');
            const mainContent = document.querySelector('.main-content');

            function updateToggleIcon() {
                if (!desktopToggleBtn) return;
                const icon = desktopToggleBtn.querySelector('i');
                if (document.body.classList.contains('sidebar-collapsed')) {
                    icon.classList.remove('fa-chevron-left');
                    icon.classList.add('fa-chevron-right');
                } else {
                    icon.classList.remove('fa-chevron-right');
                    icon.classList.add('fa-chevron-left');
                }
            }

            // Load state
            const isCollapsed = localStorage.getItem('sidebarCollapsed') === 'true';
            if (isCollapsed && window.innerWidth > 768) {
                document.body.classList.add('sidebar-collapsed');
                updateToggleIcon();
            }

            // Mobile Toggle
            if (toggleBtn) {
                toggleBtn.addEventListener('click', () => {
                    if (window.innerWidth <= 768) {
                        document.body.classList.toggle('sidebar-open');
                    }
                });
            }

            // Desktop Toggle
            if (desktopToggleBtn) {
                desktopToggleBtn.addEventListener('click', () => {
                    document.body.classList.toggle('sidebar-collapsed');
                    updateToggleIcon();
                    // Save state
                    localStorage.setItem('sidebarCollapsed', document.body.classList.contains('sidebar-collapsed'));
                });
            }

            // Mobile close on click outside
            document.addEventListener('click', (e) => {
                if (window.innerWidth <= 768 &&
                    !sidebar.contains(e.target) &&
                    toggleBtn && !toggleBtn.contains(e.target) &&
                    document.body.classList.contains('sidebar-open')) {
                    document.body.classList.remove('sidebar-open');
                }
            });
        });

        // Theme Toggle Functionality with Override Protection
        (function () {
            const themeToggleBtn = document.getElementById('theme-toggle');
            const htmlElement = document.documentElement;
            const body = document.body;

            // Get saved theme from localStorage or default to 'dark'
            const savedTheme = localStorage.getItem('theme') || 'dark';
            htmlElement.setAttribute('data-theme', savedTheme);

            // Function to check if a specialized theme is active (starts with 'theme_')
            function checkThemeOverride() {
                if (!themeToggleBtn) return;

                // Check if any class on body starts with 'theme_'
                const hasSpecialTheme = Array.from(body.classList).some(cls => cls.startsWith('theme_'));

                if (hasSpecialTheme) {
                    // Disable toggle
                    themeToggleBtn.style.opacity = '0.5';
                    themeToggleBtn.style.cursor = 'not-allowed';
                    themeToggleBtn.setAttribute('disabled', 'true');
                    themeToggleBtn.title = "Theme controlled by equipped item";

                    // Optional: Visual indicator (e.g., lock icon)
                    const icon = themeToggleBtn.querySelector('i');
                    if (icon) icon.className = 'fa-solid fa-lock';
                } else {
                    // Enable toggle
                    themeToggleBtn.style.opacity = '1';
                    themeToggleBtn.style.cursor = 'pointer';
                    themeToggleBtn.removeAttribute('disabled');
                    themeToggleBtn.title = "Toggle Theme";

                    // Restore icon based on current theme
                    const currentTheme = htmlElement.getAttribute('data-theme');
                    const icon = themeToggleBtn.querySelector('i');
                    if (icon) {
                        icon.className = currentTheme === 'dark' ? 'fa-solid fa-moon' : 'fa-solid fa-sun';
                    }
                }
            }

            // Initial check
            checkThemeOverride();

            // Observe body class changes to handle dynamic equipping
            const observer = new MutationObserver(checkThemeOverride);
            observer.observe(body, { attributes: true, attributeFilter: ['class'] });

            if (themeToggleBtn) {
                themeToggleBtn.addEventListener('click', function (e) {
                    // Double check if disabled (though pointer-events might block it, explicit check is safer)
                    if (this.hasAttribute('disabled')) {
                        e.preventDefault();
                        return;
                    }

                    // Add switching animation class
                    this.classList.add('switching');

                    // Get current theme
                    const currentTheme = htmlElement.getAttribute('data-theme');
                    const newTheme = currentTheme === 'dark' ? 'light' : 'dark';

                    // Add a subtle fade overlay for smooth transition
                    const overlay = document.createElement('div');
                    overlay.style.cssText = `
                        position: fixed;
                        inset: 0;
                        background: ${newTheme === 'light' ? '#ffffff' : '#0c0c0c'};
                        opacity: 0;
                        pointer-events: none;
                        z-index: 9999;
                        transition: opacity 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                    `;
                    document.body.appendChild(overlay);

                    // Trigger fade in
                    requestAnimationFrame(() => {
                        overlay.style.opacity = '0.3';
                    });

                    // Set new theme after brief delay
                    setTimeout(() => {
                        htmlElement.setAttribute('data-theme', newTheme);
                        localStorage.setItem('theme', newTheme);

                        // Update icon immediately
                        const icon = this.querySelector('i');
                        if (icon) icon.className = newTheme === 'dark' ? 'fa-solid fa-moon' : 'fa-solid fa-sun';

                        // Fade out overlay
                        overlay.style.opacity = '0';

                        // Remove overlay after transition
                        setTimeout(() => {
                            overlay.remove();
                        }, 300);
                    }, 150);

                    // Remove animation class after animation completes
                    setTimeout(() => {
                        this.classList.remove('switching');
                    }, 500);
                });
            }
        })();
    </script>
    <style>
        @keyframes pulse {
            0% {
                opacity: 1;
            }

            50% {
                opacity: 0.6;
            }

            100% {
                opacity: 1;
            }
        }
    </style>
    {% block scripts %}{% endblock %}
    <div id="xpModal"
        style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 2000; place-items: center; opacity: 0; transition: opacity 0.2s;">
        <div style="background: var(--bg-card); padding: 24px; border-radius: 16px; width: 90%; max-width: 350px; border: 1px solid var(--border); box-shadow: 0 10px 40px rgba(0,0,0,0.5); transform: scale(0.95); transition: transform 0.2s;"
            id="xpModalContent">
            <div style="text-align: center; margin-bottom: 20px;">
                <div
                    style="width: 60px; height: 60px; background: var(--accent-green-dim); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 16px;">
                    <i class="fa-solid fa-trophy" style="font-size: 1.5rem; color: var(--accent-green);"></i>
                </div>
                <h3 style="color: var(--text-primary); font-size: 1.2rem; margin-bottom: 8px;">Level Progress</h3>
                <p style="color: var(--text-secondary); font-size: 0.9rem;">Keep pushing! You're doing great.</p>
            </div>

            <div style="background: var(--bg-hover); padding: 16px; border-radius: 12px; margin-bottom: 24px;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 0.9rem;">
                    <span style="color: var(--text-secondary);">Current Level</span>
                    <span style="color: var(--text-primary); font-weight: 600;" id="xp-modal-level"></span>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 12px; font-size: 0.9rem;">
                    <span style="color: var(--text-secondary);">XP Remaining</span>
                    <span style="color: var(--accent-green); font-weight: 600;" id="xp-modal-remaining"></span>
                </div>
                <!-- Progress Bar -->
                <div style="height: 6px; background: var(--border); border-radius: 3px; overflow: hidden;">
                    <div id="xp-modal-bar" style="height: 100%; background: var(--accent-green); width: 0%;"></div>
                </div>
                <div style="text-align: right; margin-top: 4px; font-size: 0.8rem; color: var(--text-secondary);"
                    id="xp-modal-percent"></div>
            </div>

            <button onclick="closeXPModal()"
                style="width: 100%; padding: 12px; background: var(--text-primary); color: var(--bg-main); border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
                Got it
            </button>
        </div>
    </div>

    <script>
        function showXPModal(level, remaining, percent) {
            const modal = document.getElementById('xpModal');
            const content = document.getElementById('xpModalContent');

            document.getElementById('xp-modal-level').innerText = level;
            document.getElementById('xp-modal-remaining').innerText = remaining + " XP";
            document.getElementById('xp-modal-bar').style.width = percent + "%";
            document.getElementById('xp-modal-percent').innerText = percent + "% Completed";

            modal.style.display = 'grid';
            // Small delay for transition
            setTimeout(() => {
                modal.style.opacity = '1';
                content.style.transform = 'scale(1)';
            }, 10);
        }

        function closeXPModal() {
            const modal = document.getElementById('xpModal');
            const content = document.getElementById('xpModalContent');

            modal.style.opacity = '0';
            content.style.transform = 'scale(0.95)';

            setTimeout(() => {
                modal.style.display = 'none';
            }, 200);
        }

        // Close on outside click
        document.getElementById('xpModal').addEventListener('click', (e) => {
            if (e.target === document.getElementById('xpModal')) {
                closeXPModal();
            }
        });
    </script>
    <!-- Confetti JS -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script>
        // Global Confetti Function
        window.triggerConfetti = function () {
            var duration = 3 * 1000;
            var animationEnd = Date.now() + duration;
            var defaults = { startVelocity: 30, spread: 360, ticks: 60, zIndex: 9999 };

            function randomInOut(min, max) {
                return Math.random() * (max - min) + min;
            }

            var interval = setInterval(function () {
                var timeLeft = animationEnd - Date.now();

                if (timeLeft <= 0) {
                    return clearInterval(interval);
                }

                var particleCount = 50 * (timeLeft / duration);

                // since particles fall down, start a bit higher than random
                confetti(Object.assign({}, defaults, { particleCount, origin: { x: randomInOut(0.1, 0.3), y: Math.random() - 0.2 } }));
                confetti(Object.assign({}, defaults, { particleCount, origin: { x: randomInOut(0.7, 0.9), y: Math.random() - 0.2 } }));
            }, 250);
        }

        // Check for flash messages indicating success/level up
        document.addEventListener('DOMContentLoaded', () => {
            const flashMessages = document.querySelectorAll('.flash-message, .alert-success');
            flashMessages.forEach(msg => {
                const text = msg.textContent.toLowerCase();
                if ((text.includes('xp') && !text.includes('not enough') && !text.includes('short on funds') && !text.includes('-') && !text.includes('unchecked') && !text.includes('lost')) || text.includes('level up') || text.includes('completed')) {
                    window.triggerConfetti();
                    // Play sound if available
                    // const audio = new Audio('/static/sounds/success.mp3');
                    // audio.play().catch(e => {}); 
                }
            });
        });
    </script>
    <!-- ðŸ”” Socket.IO Browser Notifications (Global) -->
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script>
        (function () {
            // Only connect if user is authenticated (check for a user-specific element)
            try {
                const _notifSocket = io({ reconnectionAttempts: 3 });

                _notifSocket.on('connect', () => {
                    _notifSocket.emit('join_user_room', {});
                });

                // ðŸ”´ Friend went LIVE
                _notifSocket.on('friend_went_live', (d) => {
                    if (window.StudyVerse && window.StudyVerse.notify) {
                        window.StudyVerse.notify(
                            `ðŸ”´ ${d.name} is Live!`,
                            `ðŸ“š Studying: ${d.topic || 'General'} â€” Click to watch!`,
                            d.avatar || '/static/img/favicon.png',
                            'friend-live-' + d.user_id,
                            `/stream/${d.user_id}`
                        );
                    }
                });

                // âš”ï¸ Battle invite received
                _notifSocket.on('battle_invite', (d) => {
                    if (window.StudyVerse && window.StudyVerse.notify) {
                        window.StudyVerse.notify(
                            `âš”ï¸ Battle Challenge!`,
                            `${d.challenger_name || 'Someone'} challenged you to a Byte Battle!`,
                            '/static/img/favicon.png',
                            'battle-invite',
                            '/battle'
                        );
                    }
                });

                // ðŸ‘‹ Friend request received
                _notifSocket.on('friend_request_received', (d) => {
                    if (window.StudyVerse && window.StudyVerse.notify) {
                        window.StudyVerse.notify(
                            `ðŸ‘‹ New Friend Request!`,
                            `${d.from_name} wants to be your study buddy!`,
                            d.avatar || '/static/img/favicon.png',
                            'friend-request-' + d.from_id,
                            '/friends'
                        );
                    }
                });

                // ðŸ† XP / Level up notification
                _notifSocket.on('level_up', (d) => {
                    if (window.StudyVerse && window.StudyVerse.notify) {
                        window.StudyVerse.notify(
                            `ðŸŽ‰ Level Up! You're now Level ${d.new_level}!`,
                            `Keep going â€” ${d.xp_to_next} XP to reach Level ${d.new_level + 1}.`,
                            '/static/img/favicon.png',
                            'level-up',
                            '/profile'
                        );
                    }
                });

            } catch (e) {
                // Silently fail if socket not available
            }
        })();
    </script>
    <!-- Zen Mode Overlay -->
    <div id="zen-mode-overlay" class="zen-overlay">
        <!-- Minimal Header -->
        <div class="zen-header">
            <div class="zen-clock" id="zen-clock">00:00</div>
            <button id="exit-zen-btn" class="btn-zen-exit" title="Exit Zen Mode">
                <i class="fa-solid fa-person-walking-arrow-right"></i> Exit Zen
            </button>
        </div>

        <!-- Central Content (Minimal) -->
        <div class="zen-center">
            <h2 class="zen-quote" id="zen-quote">"Focus on the process, not the outcome."</h2>
            <div class="zen-author">- StudyVerse Zen</div>
        </div>

        <!-- Controls Bottom -->
        <div class="zen-controls">
            <!-- Sound Controls -->
            <div class="zen-control-group">
                <button id="zen-sound-toggle" class="btn-zen-icon"><i class="fa-solid fa-volume-off"></i></button>
                <select id="zen-sound-select" class="zen-select">
                    <option value="rain">Rain</option>
                    <option value="forest">Forest</option>
                    <option value="white_noise">White Noise</option>
                    <option value="binaural">Binaural Beats</option>
                </select>
            </div>

            <!-- Distraction Pad Toggle -->
            <div class="zen-control-group">
                <button id="distraction-pad-toggle" class="btn-zen-icon"
                    style="width: auto; gap: 8px; padding: 0 10px; border-radius: 20px;">
                    <i class="fa-solid fa-note-sticky"></i> Distraction Pad
                </button>
            </div>
        </div>

        <!-- Distraction Pad (Hidden by default) -->
        <div id="distraction-pad-container" class="distraction-pad-container">
            <div class="distraction-pad-header">
                <span>Distraction Dump</span>
                <i class="fa-solid fa-trash" style="cursor: pointer;"
                    onclick="document.getElementById('distraction-input').value = ''"></i>
            </div>
            <textarea id="distraction-input" class="distraction-input"
                placeholder="Write down what's distracting you, then let it go..."></textarea>
            <div style="font-size: 0.8rem; color: rgba(255,255,255,0.5); text-align: center;">Saved automatically</div>
        </div>
    </div>

    <!-- Zen Mode Script -->
    <script src="{{ url_for('static', filename='js/zen_mode.js') }}"></script>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
         FEEDBACK WIDGET
         â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <style>
        /* Feedback Button */
        #feedbackBtn {
            position: fixed;
            bottom: 28px;
            right: 28px;
            z-index: 3000;
            background: linear-gradient(135deg, #4ade80, #22c55e);
            color: #000;
            border: none;
            border-radius: 50px;
            padding: 12px 20px;
            font-size: 0.85rem;
            font-weight: 700;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 20px rgba(74, 222, 128, 0.4);
            transition: all 0.3s;
            animation: fbPulse 3s ease-in-out infinite;
        }

        #feedbackBtn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 30px rgba(74, 222, 128, 0.5);
        }

        @keyframes fbPulse {

            0%,
            100% {
                box-shadow: 0 4px 20px rgba(74, 222, 128, 0.4);
            }

            50% {
                box-shadow: 0 4px 30px rgba(74, 222, 128, 0.7);
            }
        }

        /* Feedback Popup */
        #feedbackPopup {
            position: fixed;
            bottom: 90px;
            right: 28px;
            z-index: 3001;
            width: 340px;
            /* Fully opaque â€” immune to light mode bleed-through */
            background: #0d1117 !important;
            color: #e2e8f0 !important;
            color-scheme: dark;
            border: 1px solid rgba(74, 222, 128, 0.3);
            border-radius: 20px;
            padding: 24px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.8), 0 0 0 1px rgba(74, 222, 128, 0.12);
            display: none;
            transform: translateY(10px);
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        #feedbackPopup.show {
            display: block;
            transform: translateY(0);
        }

        .fb-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 18px;
        }

        .fb-header h4 {
            color: #f0f6fc !important;
            font-size: 1rem;
            font-weight: 700;
            margin: 0;
        }

        .fb-close {
            background: none;
            border: none;
            color: #666;
            font-size: 1.2rem;
            cursor: pointer;
            transition: color 0.2s;
        }

        .fb-close:hover {
            color: #fff;
        }

        /* Emoji Row */
        .fb-emoji-row {
            display: flex;
            justify-content: space-around;
            margin-bottom: 18px;
        }

        .fb-emoji {
            font-size: 1.8rem;
            cursor: pointer;
            padding: 8px;
            border-radius: 12px;
            border: 2px solid transparent;
            transition: all 0.2s;
            user-select: none;
        }

        .fb-emoji:hover {
            transform: scale(1.2);
            background: rgba(255, 255, 255, 0.07);
        }

        .fb-emoji.selected {
            border-color: #4ade80;
            background: rgba(74, 222, 128, 0.15);
            transform: scale(1.15);
        }

        /* Category chips */
        .fb-categories {
            display: flex;
            gap: 8px;
            margin-bottom: 14px;
            flex-wrap: wrap;
        }

        .fb-cat-chip {
            padding: 5px 12px;
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.15);
            background: rgba(255, 255, 255, 0.08) !important;
            color: #94a3b8 !important;
            font-size: 0.78rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .fb-cat-chip:hover {
            border-color: rgba(255, 255, 255, 0.3);
            color: #e2e8f0 !important;
        }

        .fb-cat-chip.selected {
            background: rgba(74, 222, 128, 0.2) !important;
            border-color: #4ade80;
            color: #4ade80 !important;
        }

        /* Textarea */
        .fb-textarea {
            width: 100%;
            background: rgba(255, 255, 255, 0.07) !important;
            border: 1px solid rgba(255, 255, 255, 0.12);
            border-radius: 12px;
            padding: 12px;
            color: #e2e8f0 !important;
            font-size: 0.85rem;
            resize: none;
            outline: none;
            font-family: inherit;
            transition: border-color 0.2s;
            margin-bottom: 14px;
        }

        .fb-textarea:focus {
            border-color: #4ade80;
        }

        .fb-textarea::placeholder {
            color: #64748b !important;
        }

        /* Submit */
        .fb-submit {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #4ade80, #22c55e);
            color: #000;
            border: none;
            border-radius: 12px;
            font-weight: 800;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .fb-submit:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(74, 222, 128, 0.3);
        }

        .fb-submit:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* Thank you state */
        #fbThankyou {
            text-align: center;
            padding: 20px;
            display: none;
        }

        #fbThankyou .fb-ty-emoji {
            font-size: 3rem;
            margin-bottom: 12px;
        }

        #fbThankyou h4 {
            color: #4ade80;
            font-size: 1.1rem;
            margin-bottom: 8px;
        }

        #fbThankyou p {
            color: #888;
            font-size: 0.85rem;
        }

        /* â”€â”€â”€â”€ REFERRAL MODAL â”€â”€â”€â”€ */
        #referralModalOverlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 4000;
            place-items: center;
            backdrop-filter: blur(6px);
        }

        #referralModalOverlay.open {
            display: grid;
        }

        .ref-modal {
            background: #0f1423 !important;
            color: #e2e8f0 !important;
            color-scheme: dark;
            border: 1px solid rgba(74, 222, 128, 0.25);
            border-radius: 24px;
            padding: 36px;
            width: 90%;
            max-width: 460px;
            box-shadow: 0 30px 80px rgba(0, 0, 0, 0.8);
            animation: refModalIn 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        @keyframes refModalIn {
            from {
                transform: scale(0.85);
                opacity: 0;
            }

            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        .ref-modal h3 {
            font-size: 1.5rem;
            font-weight: 800;
            color: #f0f6fc !important;
            margin-bottom: 6px;
        }

        .ref-modal p {
            color: #94a3b8 !important;
            font-size: 0.9rem;
            margin-bottom: 24px;
        }

        .ref-stats-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 14px;
            margin-bottom: 24px;
        }

        .ref-stat-box {
            background: rgba(255, 255, 255, 0.04);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 14px;
            padding: 16px;
            text-align: center;
        }

        .ref-stat-val {
            font-size: 1.8rem;
            font-weight: 800;
            color: #4ade80;
        }

        .ref-stat-lbl {
            font-size: 0.75rem;
            color: #8b9eb7 !important;
            margin-top: 4px;
            text-transform: uppercase;
        }

        .ref-link-box {
            background: rgba(74, 222, 128, 0.06);
            border: 1px solid rgba(74, 222, 128, 0.2);
            border-radius: 12px;
            padding: 14px 16px;
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
        }

        .ref-link-text {
            flex: 1;
            font-size: 0.82rem;
            color: #4ade80;
            word-break: break-all;
            font-family: monospace;
        }

        .ref-copy-btn {
            background: #4ade80;
            color: #000;
            border: none;
            border-radius: 8px;
            padding: 8px 14px;
            font-weight: 700;
            font-size: 0.8rem;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.2s;
            flex-shrink: 0;
        }

        .ref-copy-btn:hover {
            background: #22c55e;
        }

        .ref-how {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 20px;
        }

        .ref-how h5 {
            color: #888;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
        }

        .ref-step {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            margin-bottom: 10px;
            font-size: 0.85rem;
            color: #ccc;
        }

        .ref-step-num {
            width: 22px;
            height: 22px;
            background: rgba(74, 222, 128, 0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: 800;
            color: #4ade80;
            flex-shrink: 0;
            margin-top: 1px;
        }
    </style>

    <!-- Feedback Button -->
    {% if current_user.is_authenticated %}
    <button id="feedbackBtn" onclick="toggleFeedback()">
        <i class="fa-regular fa-comment-dots"></i> Feedback
    </button>

    <!-- Feedback Popup -->
    <div id="feedbackPopup">
        <div id="fbForm">
            <div class="fb-header">
                <h4>âœ¨ Share Your Thoughts</h4>
                <button class="fb-close" onclick="toggleFeedback()"><i class="fa-solid fa-xmark"></i></button>
            </div>

            <!-- Emoji Rating -->
            <p style="color:#888; font-size:0.8rem; margin-bottom:10px;">How's your experience?</p>
            <div class="fb-emoji-row" id="fbEmojiRow">
                <span class="fb-emoji" data-rating="love" title="Love it!">ðŸ˜</span>
                <span class="fb-emoji" data-rating="happy" title="Happy">ðŸ˜Š</span>
                <span class="fb-emoji" data-rating="neutral" title="Neutral">ðŸ˜</span>
                <span class="fb-emoji" data-rating="sad" title="Sad">ðŸ˜ž</span>
                <span class="fb-emoji" data-rating="awful" title="Awful">ðŸ˜¡</span>
            </div>

            <!-- Category -->
            <div class="fb-categories" id="fbCategories">
                <div class="fb-cat-chip selected" data-cat="general">ðŸ’¬ General</div>
                <div class="fb-cat-chip" data-cat="bug">ðŸ› Bug Report</div>
                <div class="fb-cat-chip" data-cat="feature">âœ¨ Feature Idea</div>
            </div>

            <!-- Message -->
            <textarea class="fb-textarea" id="fbMessage" rows="3" placeholder="Tell us more... (optional)"></textarea>

            <button class="fb-submit" id="fbSubmitBtn" onclick="submitFeedback()">
                <i class="fa-solid fa-paper-plane"></i> Send Feedback
            </button>
        </div>

        <div id="fbThankyou">
            <div class="fb-ty-emoji">ðŸŽ‰</div>
            <h4>Thanks so much!</h4>
            <p>Your feedback helps us improve StudyVerse. We read every single one! â¤ï¸</p>
        </div>
    </div>

    <!-- â•â•â•â•â•â•â• REFERRAL MODAL â•â•â•â•â•â•â• -->
    <div id="referralModalOverlay" onclick="if(event.target===this) closeReferralModal()">
        <div class="ref-modal">
            <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:8px;">
                <h3>ðŸŽ Invite & Earn XP</h3>
                <button onclick="closeReferralModal()"
                    style="background:none;border:none;color:#666;font-size:1.4rem;cursor:pointer;"><i
                        class="fa-solid fa-xmark"></i></button>
            </div>
            <p>Invite friends to StudyVerse. When they join, <strong style="color:#4ade80;">you BOTH get +500 XP
                    each</strong>! ðŸš€</p>

            <!-- Stats -->
            <div class="ref-stats-row">
                <div class="ref-stat-box">
                    <div class="ref-stat-val" id="refTotalInvites">â€“</div>
                    <div class="ref-stat-lbl">Friends Invited</div>
                </div>
                <div class="ref-stat-box">
                    <div class="ref-stat-val" id="refTotalXP">â€“</div>
                    <div class="ref-stat-lbl">XP Earned</div>
                </div>
            </div>

            <!-- Referral Link -->
            <div class="ref-link-box">
                <div class="ref-link-text" id="refLink">Loadingâ€¦</div>
                <button class="ref-copy-btn" onclick="copyRefLink()">
                    <i class="fa-regular fa-copy"></i> Copy
                </button>
            </div>

            <!-- How it works -->
            <div class="ref-how">
                <h5>How it works</h5>
                <div class="ref-step">
                    <div class="ref-step-num">1</div>
                    <div>Share your unique link with a friend</div>
                </div>
                <div class="ref-step">
                    <div class="ref-step-num">2</div>
                    <div>They sign up using your link</div>
                </div>
                <div class="ref-step">
                    <div class="ref-step-num">3</div>
                    <div>You <strong style="color:#4ade80;">both</strong> get <strong style="color:#4ade80;">+500
                            XP</strong> each! ðŸŽ‰</div>
                </div>
            </div>

            <!-- Share buttons -->
            <div style="display:flex; gap:10px;">
                <button onclick="shareWhatsApp()"
                    style="flex:1; padding:12px; background:rgba(37,211,102,0.15); color:#25d366; border:1px solid rgba(37,211,102,0.3); border-radius:12px; font-weight:700; cursor:pointer; font-size:0.85rem; transition:all 0.2s;"
                    onmouseover="this.style.background='rgba(37,211,102,0.25)'"
                    onmouseout="this.style.background='rgba(37,211,102,0.15)'">
                    <i class="fa-brands fa-whatsapp"></i> WhatsApp
                </button>
                <button onclick="closeReferralModal()"
                    style="flex:1; padding:12px; background:rgba(255,255,255,0.05); color:#888; border:1px solid rgba(255,255,255,0.1); border-radius:12px; font-weight:600; cursor:pointer; font-size:0.85rem;">Close</button>
            </div>
        </div>
    </div>

    <script>
        // â•â•â•â•â•â•â• FEEDBACK WIDGET â•â•â•â•â•â•â•
        let selectedRating = 'neutral';
        let selectedCategory = 'general';

        function toggleFeedback() {
            const popup = document.getElementById('feedbackPopup');
            if (popup.classList.contains('show')) {
                popup.classList.remove('show');
                setTimeout(() => popup.style.display = 'none', 300);
            } else {
                popup.style.display = 'block';
                requestAnimationFrame(() => popup.classList.add('show'));
            }
        }

        // Emoji selection
        document.querySelectorAll('.fb-emoji').forEach(el => {
            el.addEventListener('click', () => {
                document.querySelectorAll('.fb-emoji').forEach(e => e.classList.remove('selected'));
                el.classList.add('selected');
                selectedRating = el.dataset.rating;
            });
        });

        // Category selection
        document.querySelectorAll('.fb-cat-chip').forEach(el => {
            el.addEventListener('click', () => {
                document.querySelectorAll('.fb-cat-chip').forEach(e => e.classList.remove('selected'));
                el.classList.add('selected');
                selectedCategory = el.dataset.cat;
            });
        });

        async function submitFeedback() {
            const btn = document.getElementById('fbSubmitBtn');
            const message = document.getElementById('fbMessage').value.trim();

            btn.disabled = true;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Sending...';

            try {
                const res = await fetch('/api/feedback', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        rating: selectedRating,
                        message: message,
                        category: selectedCategory,
                        page_url: window.location.pathname
                    })
                });
                const data = await res.json();
                if (data.status === 'success') {
                    document.getElementById('fbForm').style.display = 'none';
                    document.getElementById('fbThankyou').style.display = 'block';
                    setTimeout(() => {
                        toggleFeedback();
                        setTimeout(() => {
                            document.getElementById('fbForm').style.display = 'block';
                            document.getElementById('fbThankyou').style.display = 'none';
                            document.getElementById('fbMessage').value = '';
                            btn.disabled = false;
                            btn.innerHTML = '<i class="fa-solid fa-paper-plane"></i> Send Feedback';
                        }, 400);
                    }, 2500);
                } else {
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fa-solid fa-paper-plane"></i> Send Feedback';
                }
            } catch (e) {
                btn.disabled = false;
                btn.innerHTML = '<i class="fa-solid fa-paper-plane"></i> Send Feedback';
            }
        }

        // â•â•â•â•â•â•â• REFERRAL SYSTEM â•â•â•â•â•â•â•
        let _refLink = '';

        async function openReferralModal() {
            document.getElementById('referralModalOverlay').classList.add('open');
            const res = await fetch('/api/referral/info');
            const data = await res.json();
            if (data.status === 'success') {
                _refLink = data.referral_link;
                document.getElementById('refLink').textContent = data.referral_link;
                document.getElementById('refTotalInvites').textContent = data.total_referrals;
                document.getElementById('refTotalXP').textContent = '+' + data.total_xp_earned + ' XP';
            }
        }

        function closeReferralModal() {
            document.getElementById('referralModalOverlay').classList.remove('open');
        }

        function copyRefLink() {
            if (!_refLink) return;
            navigator.clipboard.writeText(_refLink).then(() => {
                const btn = document.querySelector('.ref-copy-btn');
                btn.innerHTML = '<i class="fa-solid fa-check"></i> Copied!';
                btn.style.background = '#22c55e';
                setTimeout(() => {
                    btn.innerHTML = '<i class="fa-regular fa-copy"></i> Copy';
                    btn.style.background = '#4ade80';
                }, 2000);
            });
        }

        function shareWhatsApp() {
            if (!_refLink) return;
            const text = encodeURIComponent(`Hey! I've been using StudyVerse to boost my studies ðŸ“šðŸš€\n\nIt has AI coaching, battle quizzes, streaks and more!\n\nJoin using my invite link â€” we both get 500 XP ðŸŽ\n${_refLink}`);
            window.open(`https://wa.me/?text=${text}`, '_blank');
        }
    </script>

    <!-- Nova UI -->
    <div class="secretary-orb" id="sec-orb" title="Talk to Nova">
        <div class="orb-core"></div><span class="orb-label">Nova</span>
    </div>
    <div class="secretary-panel" id="sec-panel">
        <div class="sec-header">
            <div class="sec-title"><i class="fa-solid fa-microchip"></i> Nova <span class="sec-thinking"
                    id="sec-thinking">thinking...</span></div>
            <div>
                <button class="sec-close" id="sec-mute-btn" title="Mute Nova"><i
                        class="fa-solid fa-volume-high"></i></button>
                <button class="sec-close" id="sec-clear-btn" title="Clear Chat"><i
                        class="fa-solid fa-trash"></i></button>
                <button class="sec-close" id="sec-close-btn" title="Close"><i class="fa-solid fa-xmark"></i></button>
            </div>
        </div>
        <div class="sec-chat-area" id="sec-chat-area"></div>
        <div class="sec-input-container">
            <input type="text" class="sec-input" id="sec-input" placeholder="Type or tap mic..." autocomplete="off">
            <button class="sec-btn" id="sec-mic-btn" title="Voice Input"><i
                    class="fa-solid fa-microphone"></i></button>
            <button class="sec-btn" id="sec-send-btn" title="Send" style="display:none;"><i
                    class="fa-solid fa-paper-plane"></i></button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- 3. NOVA AI LOGIC ---
            const orb = document.getElementById('sec-orb');
            const panel = document.getElementById('sec-panel');
            if (orb && panel) {
                const input = document.getElementById('sec-input');
                const micBtn = document.getElementById('sec-mic-btn');
                const sendBtn = document.getElementById('sec-send-btn');
                const chatArea = document.getElementById('sec-chat-area');
                const thinking = document.getElementById('sec-thinking');
                const muteBtn = document.getElementById('sec-mute-btn');
                const clearBtn = document.getElementById('sec-clear-btn');
                const closeBtn = document.getElementById('sec-close-btn');

                let isMuted = localStorage.getItem('nova_muted') === 'true';
                let isSpeaking = false;
                let chatHistory = JSON.parse(sessionStorage.getItem('nova_history') || '[]');
                let inConversation = false;
                let wakeOn = false;
                let silenceTimeout = null;
                const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
                const synth = window.speechSynthesis;
                let cmdRec = null, wakeRec = null;

                function appendMsg(txt, isUser) {
                    if (!txt) return;
                    const div = document.createElement('div');
                    div.className = 'sec-msg ' + (isUser ? 'user' : 'ai');
                    div.textContent = txt;
                    chatArea.appendChild(div);
                    chatArea.scrollTop = chatArea.scrollHeight;
                }

                function setOrbState(s) {
                    orb.classList.remove('speaking', 'listening', 'thinking');
                    if (s) orb.classList.add(s);
                }

                // --- AUDIO UNLOCK FOR BROWSERS ---
                let audioUnlocked = false;
                function unlockAudio() {
                    if (audioUnlocked || !synth) return;
                    // Speak a silent utterance to unlock audio context
                    const silent = new SpeechSynthesisUtterance("");
                    silent.volume = 0;
                    synth.speak(silent);
                    audioUnlocked = true;
                    console.log("Nova: Audio context unlocked.");
                    document.removeEventListener('click', unlockAudio);
                    document.removeEventListener('touchstart', unlockAudio);
                }
                document.addEventListener('click', unlockAudio);
                document.addEventListener('touchstart', unlockAudio);

                async function handleSend(msgText) {
                    const msg = (typeof msgText === 'string' ? msgText : input.value).trim();
                    if (!msg) return;

                    if (msg.toLowerCase().includes('clear chat')) {
                        chatArea.innerHTML = ''; chatHistory = []; sessionStorage.removeItem('nova_history');
                        speak("Done. Chat cleared."); return;
                    }

                    appendMsg(msg, true);
                    input.value = '';
                    thinking.classList.add('active');
                    setOrbState('thinking');

                    try {
                        const res = await fetch('/api/secretary/chat', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ message: msg, history: chatHistory })
                        });
                        const data = await res.json();
                        if (data.error) throw new Error(data.error);

                        appendMsg(data.reply, false);
                        chatHistory.push({ role: 'user', content: msg }, { role: 'assistant', content: data.reply });
                        sessionStorage.setItem('nova_history', JSON.stringify(chatHistory.slice(-15)));

                        if (data.action && data.action.url) {
                            sessionStorage.setItem('nova_pending_speech', data.reply);
                            window.location.href = data.action.url;
                            return;
                        }

                        if (data.action && data.action.type === 'enable_proxy') {
                            sessionStorage.setItem('nova_proxy_enabled', data.action.enabled);
                            console.log("Nova Proxy Mode:", data.action.enabled);
                        }

                        speak(data.reply);
                    } catch (e) {
                        appendMsg("Connection error. API might be down.", false);
                        setOrbState(null);
                    } finally {
                        thinking.classList.remove('active');
                    }
                }

                // --- BULLETPROOF SPEECH ENGINE ---
                let availableVoices = [];
                function loadVoices() {
                    availableVoices = synth.getVoices();
                    if (availableVoices.length > 0) {
                        console.log("Nova: " + availableVoices.length + " voices loaded.");
                    }
                }
                if (synth) {
                    synth.onvoiceschanged = loadVoices;
                    loadVoices();
                }

                window._novaUtter = null;
                function speak(txt) {
                    if (!synth) return;

                    // Force reset & STOP recognition while speaking to prevent self-triggering
                    synth.cancel();
                    stopWake();
                    if (cmdRec) { try { cmdRec.stop(); } catch(e){} }
                    
                    if (window._novaHeartbeat) clearInterval(window._novaHeartbeat);

                    if (isMuted) {
                        setOrbState(null);
                        if (inConversation) setTimeout(startCommandMode, 100); else startWake();
                        return;
                    }

                    const cleanText = txt.replace(/```[\s\S]*?```/g, ' Snippet provided. ').replace(/[*#_`]/g, '');
                    const utter = new SpeechSynthesisUtterance(cleanText);
                    window._novaUtter = utter;

                    // Voice selection
                    const v = availableVoices;
                    const preferredVoice =
                        v.find(x => x.lang === 'en-IN' && x.name.includes('Natural')) ||
                        v.find(x => x.lang === 'en-IN' && x.name.includes('Google')) ||
                        v.find(x => x.lang === 'en-IN') ||
                        v.find(x => x.name.includes('Natural')) ||
                        v.find(x => x.lang.startsWith('en')) ||
                        v[0];

                    if (preferredVoice) {
                        utter.voice = preferredVoice;
                        utter.lang = preferredVoice.lang;
                    } else {
                        utter.lang = 'en-IN';
                    }

                    utter.pitch = 1.0;
                    utter.rate = 1.0;

                    utter.onstart = () => {
                        isSpeaking = true;
                        setOrbState('speaking');
                    };

                    const handleEnd = () => {
                        isSpeaking = false;
                        setOrbState(null);
                        if (window._novaHeartbeat) clearInterval(window._novaHeartbeat);
                        // Only restart recognition after speech is fully done
                        if (inConversation) setTimeout(startCommandMode, 300); else startWake();
                    };

                    utter.onend = handleEnd;
                    utter.onerror = handleEnd;

                    // Keep-alive heartbeat
                    window._novaHeartbeat = setInterval(() => {
                        if (synth.speaking) { synth.pause(); synth.resume(); }
                        else { clearInterval(window._novaHeartbeat); }
                    }, 10000);

                    synth.speak(utter);
                }

                function startWake() {
                    // Safety: Don't start wake if Nova is speaking
                    if (!wakeRec || wakeOn || isSpeaking || inConversation || synth.speaking) return;
                    try {
                        wakeRec.lang = 'en-IN';
                        wakeRec.start();
                        wakeOn = true;
                    } catch (e) { wakeOn = false; }
                }
                function stopWake() { if (wakeRec && wakeOn) { try { wakeRec.stop(); } catch (e) { } wakeOn = false; } }

                function startCommandMode() {
                    stopWake();
                    if (!cmdRec) return;
                    try {
                        cmdRec.lang = 'en-IN';
                        cmdRec.start();
                    } catch (e) { }
                }

                if (SR) {
                    cmdRec = new SR();
                    cmdRec.lang = 'en-IN';
                    cmdRec.interimResults = true;
                    cmdRec.onstart = () => { setOrbState('listening'); };
                    cmdRec.onresult = e => {
                        let result = '';
                        for (let i = e.resultIndex; i < e.results.length; i++) {
                            result += e.results[i][0].transcript;
                        }
                        input.value = result;
                        if (e.results[e.results.length - 1].isFinal) {
                            handleSend(result);
                        }
                    };
                    cmdRec.onend = () => {
                        if (!isSpeaking && inConversation) {
                            if (input.value === '') setTimeout(startCommandMode, 100);
                        } else if (!isSpeaking) {
                            setOrbState(null); startWake();
                        }
                    };

                    wakeRec = new SR();
                    wakeRec.continuous = true;
                    wakeRec.interimResults = true;

                    // USER PROTECTED PATTERNS
                    const patterns = /nova|nowa|no va|noova|novah|norva/i;

                    wakeRec.onresult = e => {
                        for (let i = e.resultIndex; i < e.results.length; i++) {
                            const t = e.results[i][0].transcript.toLowerCase();
                            if (patterns.test(t)) {
                                synth.cancel();
                                inConversation = true;
                                stopWake();
                                startCommandMode();
                                return;
                            }
                        }
                    };
                    wakeRec.onend = () => { wakeOn = false; if (!isSpeaking && !inConversation) setTimeout(startWake, 500); };

                    if (synth) {
                        synth.onvoiceschanged = () => { synth.getVoices(); };
                    }

                    startWake();
                }

                orb.addEventListener('click', () => {
                    if (isSpeaking || wakeOn) { synth.cancel(); stopWake(); inConversation = false; }
                    panel.classList.toggle('open');
                    if (panel.classList.contains('open')) input.focus(); else startWake();
                });
                closeBtn.addEventListener('click', () => { panel.classList.remove('open'); inConversation = false; startWake(); });
                clearBtn.addEventListener('click', () => { chatArea.innerHTML = ''; chatHistory = []; sessionStorage.removeItem('nova_history'); });
                muteBtn.addEventListener('click', () => {
                    isMuted = !isMuted; localStorage.setItem('nova_muted', isMuted);
                    muteBtn.querySelector('i').className = isMuted ? 'fa-solid fa-volume-xmark' : 'fa-solid fa-volume-high';
                    if (isMuted) synth.cancel();
                });

                input.addEventListener('input', () => {
                    const has = input.value.trim().length > 0;
                    micBtn.style.display = has ? 'none' : 'block';
                    sendBtn.style.display = has ? 'block' : 'none';
                });
                input.addEventListener('keypress', e => { if (e.key === 'Enter') { inConversation = false; handleSend(); } });
                sendBtn.addEventListener('click', () => { inConversation = false; handleSend(); });
                micBtn.addEventListener('click', () => { inConversation = true; startCommandMode(); });

                if (chatHistory.length === 0) {
                    const greeting = "Hello! I'm Nova. How can I help you today?";
                    appendMsg(greeting, false);
                    // Use timeout to allow voices to load and ensure speech unlock
                    setTimeout(() => speak(greeting), 1500);
                } else { chatHistory.forEach(m => appendMsg(m.content, m.role === 'user')); }

                // --- PENDING SPEECH FIX ---
                const pending = sessionStorage.getItem('nova_pending_speech');
                if (pending) {
                    sessionStorage.removeItem('nova_pending_speech');
                    // Small delay to let browser settle
                    setTimeout(() => speak(pending), 1000);
                }

                // Wake keep-alive
                setInterval(() => { if (!wakeOn && !isSpeaking && !inConversation) startWake(); }, 5000);

                // --- GLOBAL NOTIFICATIONS ---
                if (typeof io !== 'undefined') {
                    // Use existing socket if possible or connect to /
                    const globalSocket = io('/');
                    globalSocket.on('friend_request_received', (data) => {
                        console.log("Friend request from:", data.from_user);
                        speak(`Bhai, ${data.from_user} ne aapko friend request bheji hai! Check karlo.`);
                    });
                }
            }
        });
    </script>
    {% endif %}

</body>

</html>