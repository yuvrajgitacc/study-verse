{% extends "layout.html" %}
{% block title %}AI Topic Resolver - StudyVerse{% endblock %}

{% block content %}
<style>
    /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     AI TOPIC RESOLVER ‚Äî PAGE STYLES
  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
    .resolver-wrapper {
        padding: 28px 32px;
        max-width: 1200px;
        margin: 0 auto;
        animation: fadeInUp 0.5s ease;
    }

    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(16px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* ‚îÄ‚îÄ Header ‚îÄ‚îÄ */
    .resolver-header {
        margin-bottom: 28px;
    }

    .resolver-header h1 {
        font-size: 28px;
        font-weight: 800;
        background: linear-gradient(135deg, #a78bfa, #60a5fa, #34d399);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        margin-bottom: 6px;
    }

    .resolver-header p {
        color: var(--text-secondary);
        font-size: 14px;
    }

    /* ‚îÄ‚îÄ Search / Input Box ‚îÄ‚îÄ */
    .search-box {
        background: var(--bg-card);
        border: 1px solid var(--border);
        border-radius: 18px;
        padding: 24px 28px;
        margin-bottom: 28px;
        transition: border-color 0.3s;
    }

    .search-box:focus-within {
        border-color: #a78bfa;
    }

    .search-label {
        font-size: 13px;
        font-weight: 600;
        color: var(--text-secondary);
        text-transform: uppercase;
        letter-spacing: 0.8px;
        margin-bottom: 12px;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .search-label i {
        color: #a78bfa;
    }

    .search-row {
        display: flex;
        gap: 12px;
        align-items: flex-end;
        flex-wrap: wrap;
    }

    .search-input-wrap {
        flex: 1;
        min-width: 240px;
    }

    .search-input-wrap input {
        width: 100%;
        background: var(--bg-main);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 14px 18px;
        color: var(--text-primary);
        font-size: 15px;
        outline: none;
        transition: border-color 0.2s, box-shadow 0.2s;
    }

    .search-input-wrap input:focus {
        border-color: #a78bfa;
        box-shadow: 0 0 0 3px rgba(167, 139, 250, 0.12);
    }

    .search-input-wrap input::placeholder {
        color: var(--text-muted);
    }

    .btn-resolve {
        background: linear-gradient(135deg, #7c3aed, #4f46e5);
        color: white;
        border: none;
        padding: 14px 28px;
        border-radius: 12px;
        font-size: 14px;
        font-weight: 700;
        cursor: pointer;
        white-space: nowrap;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: all 0.2s;
        box-shadow: 0 4px 16px rgba(124, 58, 237, 0.3);
    }

    .btn-resolve:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 24px rgba(124, 58, 237, 0.4);
    }

    .btn-resolve:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
    }

    /* Weak topic quick picks from syllabus */
    .quick-topics {
        margin-top: 14px;
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        align-items: center;
    }

    .quick-topics-label {
        font-size: 12px;
        color: var(--text-muted);
        font-weight: 600;
    }

    .topic-chip {
        background: rgba(167, 139, 250, 0.08);
        border: 1px solid rgba(167, 139, 250, 0.2);
        color: #a78bfa;
        border-radius: 20px;
        padding: 5px 14px;
        font-size: 12.5px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
    }

    .topic-chip:hover {
        background: rgba(167, 139, 250, 0.18);
        border-color: #a78bfa;
    }

    /* ‚îÄ‚îÄ Loading Skeleton ‚îÄ‚îÄ */
    .loading-state {
        display: none;
        text-align: center;
        padding: 60px 20px;
    }

    .loading-state.active {
        display: block;
    }

    .loading-spinner {
        width: 52px;
        height: 52px;
        border: 3px solid var(--border);
        border-top-color: #a78bfa;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
        margin: 0 auto 20px;
    }

    @keyframes spin {
        to {
            transform: rotate(360deg);
        }
    }

    .loading-state h3 {
        color: var(--text-primary);
        font-size: 16px;
        font-weight: 700;
        margin-bottom: 8px;
    }

    .loading-state p {
        color: var(--text-muted);
        font-size: 13.5px;
    }

    .loading-dots span {
        display: inline-block;
        animation: blink 1.4s infinite;
        color: #a78bfa;
        font-size: 20px;
        line-height: 1;
    }

    .loading-dots span:nth-child(2) {
        animation-delay: 0.2s;
    }

    .loading-dots span:nth-child(3) {
        animation-delay: 0.4s;
    }

    @keyframes blink {

        0%,
        80%,
        100% {
            opacity: 0;
        }

        40% {
            opacity: 1;
        }
    }

    /* ‚îÄ‚îÄ Results Grid ‚îÄ‚îÄ */
    .results-area {
        display: none;
    }

    .results-area.active {
        display: block;
        animation: fadeInUp 0.4s ease;
    }

    .results-topic-banner {
        background: linear-gradient(135deg, rgba(124, 58, 237, 0.15), rgba(79, 70, 229, 0.08));
        border: 1px solid rgba(124, 58, 237, 0.25);
        border-radius: 14px;
        padding: 18px 24px;
        margin-bottom: 24px;
        display: flex;
        align-items: center;
        gap: 16px;
    }

    .results-topic-banner .topic-icon {
        width: 48px;
        height: 48px;
        border-radius: 12px;
        background: linear-gradient(135deg, #7c3aed, #4f46e5);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
        flex-shrink: 0;
    }

    .results-topic-banner h2 {
        font-size: 17px;
        font-weight: 800;
        color: var(--text-primary);
        margin-bottom: 4px;
    }

    .results-topic-banner p {
        font-size: 12.5px;
        color: var(--text-muted);
        margin: 0;
    }

    /* ‚îÄ‚îÄ Three Column Layout ‚îÄ‚îÄ */
    .results-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        grid-template-rows: auto auto;
        gap: 20px;
    }

    /* AI Explanation (spans full left column) */
    .panel-explanation {
        grid-row: 1 / 3;
    }

    /* Section panels */
    .result-panel {
        background: var(--bg-card);
        border: 1px solid var(--border);
        border-radius: 16px;
        overflow: hidden;
        display: flex;
        flex-direction: column;
    }

    .panel-header {
        padding: 16px 20px;
        border-bottom: 1px solid var(--border);
        display: flex;
        align-items: center;
        gap: 10px;
        background: rgba(255, 255, 255, 0.015);
    }

    .panel-header .panel-icon {
        width: 34px;
        height: 34px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 15px;
    }

    .panel-icon-purple {
        background: rgba(167, 139, 250, 0.12);
        color: #a78bfa;
    }

    .panel-icon-red {
        background: rgba(239, 68, 68, 0.12);
        color: #f87171;
    }

    .panel-icon-teal {
        background: rgba(52, 211, 153, 0.12);
        color: #34d399;
    }

    .panel-title {
        font-size: 14px;
        font-weight: 700;
        color: var(--text-primary);
    }

    .panel-subtitle {
        font-size: 11.5px;
        color: var(--text-muted);
        margin-left: auto;
    }

    .panel-body {
        padding: 20px;
        flex: 1;
    }

    /* ‚îÄ‚îÄ AI Explanation Styles ‚îÄ‚îÄ */
    .ai-explanation-text {
        color: var(--text-secondary);
        font-size: 14px;
        line-height: 1.8;
        white-space: pre-wrap;
    }

    .ai-explanation-text strong {
        color: var(--text-primary);
    }

    /* Key points list */
    .key-points {
        margin-top: 16px;
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .key-point {
        display: flex;
        gap: 10px;
        align-items: flex-start;
        padding: 10px 14px;
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid var(--border);
        border-radius: 10px;
        font-size: 13.5px;
        color: var(--text-secondary);
        line-height: 1.5;
    }

    .kp-icon {
        color: #a78bfa;
        flex-shrink: 0;
        margin-top: 2px;
        font-size: 13px;
    }

    /* Common mistakes */
    .mistakes-box {
        margin-top: 14px;
        padding: 14px 16px;
        background: rgba(239, 68, 68, 0.05);
        border: 1px solid rgba(239, 68, 68, 0.15);
        border-radius: 10px;
    }

    .mistakes-box h4 {
        font-size: 12px;
        text-transform: uppercase;
        letter-spacing: 0.8px;
        color: #f87171;
        font-weight: 700;
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .mistakes-box p {
        font-size: 13px;
        color: var(--text-secondary);
        line-height: 1.6;
        margin: 0;
    }

    /* Memory trick */
    .memory-trick {
        margin-top: 14px;
        padding: 14px 16px;
        background: rgba(52, 211, 153, 0.05);
        border: 1px solid rgba(52, 211, 153, 0.15);
        border-radius: 10px;
    }

    .memory-trick h4 {
        font-size: 12px;
        text-transform: uppercase;
        letter-spacing: 0.8px;
        color: #34d399;
        font-weight: 700;
        margin-bottom: 6px;
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .memory-trick p {
        font-size: 13.5px;
        color: var(--text-secondary);
        font-style: italic;
        margin: 0;
        line-height: 1.6;
    }

    /* ‚îÄ‚îÄ VIDEO CARDS ‚îÄ‚îÄ */
    .video-card {
        display: flex;
        gap: 14px;
        align-items: flex-start;
        padding: 12px;
        border: 1px solid var(--border);
        border-radius: 12px;
        background: var(--bg-card-2);
        text-decoration: none;
        color: inherit;
        transition: all 0.2s;
        margin-bottom: 10px;
    }

    .video-card:hover {
        border-color: #f87171;
        background: rgba(239, 68, 68, 0.04);
        transform: translateX(3px);
    }

    .video-card:last-child {
        margin-bottom: 0;
    }

    .video-thumb {
        width: 100px;
        height: 60px;
        border-radius: 8px;
        object-fit: cover;
        flex-shrink: 0;
        background: var(--border);
    }

    .video-info {
        flex: 1;
        min-width: 0;
    }

    .video-title {
        font-size: 13px;
        font-weight: 600;
        color: var(--text-primary);
        display: -webkit-box;
        -webkit-line-clamp: 2;
        line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
        margin-bottom: 4px;
        line-height: 1.4;
    }

    .video-meta {
        display: flex;
        gap: 12px;
        align-items: center;
        font-size: 11.5px;
        color: var(--text-muted);
    }

    .video-channel {
        font-weight: 500;
        color: #f87171;
    }

    .video-duration,
    .video-views {
        display: flex;
        align-items: center;
        gap: 4px;
    }

    .yt-badge {
        background: rgba(239, 68, 68, 0.15);
        color: #f87171;
        border-radius: 4px;
        padding: 2px 6px;
        font-size: 10px;
        font-weight: 700;
        display: flex;
        align-items: center;
        gap: 4px;
        flex-shrink: 0;
    }

    .no-videos-msg {
        text-align: center;
        padding: 30px 20px;
        color: var(--text-muted);
        font-size: 13px;
    }

    .no-videos-msg i {
        font-size: 28px;
        opacity: 0.3;
        display: block;
        margin-bottom: 10px;
    }

    /* ‚îÄ‚îÄ AI DIAGRAM / IMAGE ‚îÄ‚îÄ */
    .diagram-wrap {
        text-align: center;
    }

    .diagram-img {
        width: 100%;
        border-radius: 12px;
        border: 1px solid var(--border);
        object-fit: cover;
        max-height: 320px;
        transition: transform 0.3s;
        cursor: zoom-in;
    }

    .diagram-img:hover {
        transform: scale(1.02);
    }

    .diagram-placeholder {
        padding: 40px 20px;
        color: var(--text-muted);
        background: rgba(255, 255, 255, 0.02);
        border: 2px dashed var(--border);
        border-radius: 12px;
        font-size: 13px;
        line-height: 1.8;
    }

    .diagram-placeholder i {
        font-size: 32px;
        opacity: 0.3;
        display: block;
        margin-bottom: 12px;
    }

    .diagram-actions {
        margin-top: 14px;
        display: flex;
        gap: 8px;
        justify-content: center;
        flex-wrap: wrap;
    }

    .btn-diagram {
        padding: 8px 18px;
        border-radius: 8px;
        font-size: 12.5px;
        font-weight: 600;
        cursor: pointer;
        border: none;
        display: flex;
        align-items: center;
        gap: 6px;
        transition: all 0.2s;
    }

    .btn-diagram-dl {
        background: rgba(52, 211, 153, 0.1);
        color: #34d399;
        border: 1px solid rgba(52, 211, 153, 0.2);
    }

    .btn-diagram-dl:hover {
        background: rgba(52, 211, 153, 0.2);
    }

    .btn-diagram-re {
        background: rgba(167, 139, 250, 0.1);
        color: #a78bfa;
        border: 1px solid rgba(167, 139, 250, 0.2);
    }

    .btn-diagram-re:hover {
        background: rgba(167, 139, 250, 0.2);
    }

    /* Generating animation */
    .generating-img {
        width: 100%;
        height: 220px;
        border-radius: 12px;
        background: linear-gradient(90deg,
                rgba(255, 255, 255, 0.03) 25%,
                rgba(167, 139, 250, 0.07) 50%,
                rgba(255, 255, 255, 0.03) 75%);
        background-size: 200% 100%;
        animation: shimmer 1.5s infinite;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-direction: column;
        gap: 10px;
        color: var(--text-muted);
    }

    @keyframes shimmer {
        to {
            background-position: -200% 0;
        }
    }

    /* ‚îÄ‚îÄ Empty/Error state ‚îÄ‚îÄ */
    .error-state {
        display: none;
        text-align: center;
        padding: 40px;
        color: var(--text-muted);
    }

    .error-state.active {
        display: block;
    }

    .error-state i {
        font-size: 32px;
        color: #f87171;
        margin-bottom: 12px;
    }

    /* ‚îÄ‚îÄ XP Earned Badge ‚îÄ‚îÄ */
    .xp-earned-badge {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        background: rgba(74, 222, 128, 0.12);
        color: #4ade80;
        border: 1px solid rgba(74, 222, 128, 0.2);
        padding: 4px 14px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 700;
        margin-left: auto;
    }

    /* Lightbox for diagram zoom */
    .lightbox {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.9);
        z-index: 3000;
        place-items: center;
        cursor: zoom-out;
    }

    .lightbox.open {
        display: grid;
        animation: fadeInUp 0.2s ease;
    }

    .lightbox img {
        max-width: 90vw;
        max-height: 90vh;
        border-radius: 12px;
    }

    /* Responsive */
    @media (max-width: 768px) {
        .results-grid {
            grid-template-columns: 1fr;
        }

        .panel-explanation {
            grid-row: auto;
        }

        .resolver-wrapper {
            padding: 16px;
        }
    }
</style>

<div class="resolver-wrapper">
    <!-- Header -->
    <div class="resolver-header">
        <h1><i class="fa-solid fa-wand-magic-sparkles" style="font-size:22px; -webkit-text-fill-color:#a78bfa;"></i> AI
            Topic Resolver</h1>
        <p>Enter any weak topic ‚Äî get an AI explanation, curated YouTube videos, and an AI-generated visual diagram
            instantly.</p>
    </div>

    <!-- Search Box -->
    <div class="search-box">
        <div class="search-label">
            <i class="fa-solid fa-magnifying-glass"></i>
            Enter Your Weak Topic
        </div>
        <div class="search-row">
            <div class="search-input-wrap">
                <input type="text" id="topicInput"
                    placeholder="e.g. Integration by Parts, Newton's 3rd Law, Photosynthesis..." autocomplete="off"
                    onkeydown="if(event.key==='Enter') resolveTopicFull()" />
            </div>
            <button class="btn-resolve" id="resolveBtn" onclick="resolveTopicFull()">
                <i class="fa-solid fa-bolt"></i> Resolve Now
            </button>
        </div>

        <!-- Quick picks from syllabus weak topics -->
        {% if weak_topics %}
        <div class="quick-topics">
            <span class="quick-topics-label">Your Weak Topics:</span>
            {% for t in weak_topics[:6] %}
            <span class="topic-chip" onclick="quickPick('{{ t.topic_name }}')">
                {{ t.topic_name[:30] }}{% if t.topic_name|length > 30 %}‚Ä¶{% endif %} <span style="opacity:0.6;">({{
                    t.proficiency }}%)</span>
            </span>
            {% endfor %}
        </div>
        {% endif %}
    </div>

    <!-- Loading State -->
    <div class="loading-state" id="loadingState">
        <div class="loading-spinner"></div>
        <h3>AI is analysing your topic<span class="loading-dots">
                <span>.</span><span>.</span><span>.</span>
            </span></h3>
        <p id="loadingMsg">Generating smart explanation</p>
    </div>

    <!-- Error State -->
    <div class="error-state" id="errorState">
        <i class="fa-solid fa-circle-exclamation"></i>
        <h3 style="color:var(--text-primary); margin-bottom:8px;">Something went wrong</h3>
        <p id="errorMsg">Please try again.</p>
    </div>

    <!-- Results Area -->
    <div class="results-area" id="resultsArea">

        <!-- Topic Banner -->
        <div class="results-topic-banner">
            <div class="topic-icon">üî≠</div>
            <div>
                <h2 id="result-topic-title">Topic Name</h2>
                <p id="result-topic-sub">AI-powered deep dive ‚Ä¢ YouTube curated videos ‚Ä¢ Visual diagram</p>
            </div>
            <div class="xp-earned-badge" id="xpBadge" style="display:none;">
                <i class="fa-solid fa-star"></i> +15 XP Earned
            </div>
        </div>

        <!-- Three-panel Grid -->
        <div class="results-grid">

            <!-- LEFT: AI Explanation -->
            <div class="result-panel panel-explanation">
                <div class="panel-header">
                    <div class="panel-icon panel-icon-purple"><i class="fa-solid fa-brain"></i></div>
                    <span class="panel-title">AI Deep Explanation</span>
                    <span class="panel-subtitle" id="explainTime"></span>
                </div>
                <div class="panel-body">
                    <div id="explanationContent">
                        <div class="ai-explanation-text" id="explanationText"></div>
                        <div class="key-points" id="keyPoints"></div>
                        <div class="mistakes-box" id="mistakesBox" style="display:none;">
                            <h4><i class="fa-solid fa-triangle-exclamation"></i> Common Mistakes</h4>
                            <p id="mistakesText"></p>
                        </div>
                        <div class="memory-trick" id="memoryTrick" style="display:none;">
                            <h4><i class="fa-solid fa-lightbulb"></i> Memory Trick</h4>
                            <p id="memoryText"></p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- RIGHT TOP: YouTube Videos -->
            <div class="result-panel">
                <div class="panel-header">
                    <div class="panel-icon panel-icon-red"><i class="fa-brands fa-youtube"></i></div>
                    <span class="panel-title">Top Learning Videos</span>
                    <span class="panel-subtitle" id="videoCount"></span>
                </div>
                <div class="panel-body" id="videosList">
                    <div class="no-videos-msg">
                        <i class="fa-brands fa-youtube"></i>
                        Videos will appear here after resolving a topic.
                    </div>
                </div>
            </div>

            <!-- RIGHT BOTTOM: AI Diagram -->
            <div class="result-panel">
                <div class="panel-header">
                    <div class="panel-icon panel-icon-teal"><i class="fa-solid fa-image"></i></div>
                    <span class="panel-title">AI Visual Diagram</span>
                    <span class="panel-subtitle" id="diagramStatus">Powered by Gemini</span>
                </div>
                <div class="panel-body">
                    <div class="diagram-wrap" id="diagramWrap">
                        <div class="diagram-placeholder">
                            <i class="fa-solid fa-image"></i>
                            AI will generate a custom visual diagram for your topic here.
                        </div>
                    </div>
                    <div class="diagram-actions" id="diagramActions" style="display:none;">
                        <button class="btn-diagram btn-diagram-dl" id="downloadDiagramBtn" onclick="downloadDiagram()">
                            <i class="fa-solid fa-download"></i> Save Diagram
                        </button>
                        <button class="btn-diagram btn-diagram-re" onclick="regenerateDiagram()">
                            <i class="fa-solid fa-rotate"></i> Regenerate
                        </button>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

<!-- Lightbox for diagram zoom -->
<div class="lightbox" id="lightbox" onclick="this.classList.remove('open')">
    <img id="lightboxImg" src="" alt="Diagram Zoom">
</div>

<script>
    document.querySelector('[data-nav="resolver"]') &&
        document.querySelector('[data-nav="resolver"]').classList.add('active');

    let currentTopic = '';
    let currentDiagramUrl = '';

    function quickPick(topic) {
        document.getElementById('topicInput').value = topic;
        resolveTopicFull();
    }

    async function resolveTopicFull() {
        const input = document.getElementById('topicInput');
        const topic = input.value.trim();
        if (!topic) {
            input.focus();
            input.style.borderColor = '#f87171';
            setTimeout(() => input.style.borderColor = '', 1200);
            return;
        }
        currentTopic = topic;

        // Show loading, hide others
        showSection('loading');
        document.getElementById('resolveBtn').disabled = true;
        setLoadingMsg('Generating smart explanation');

        try {
            // Step 1: AI Explanation
            setLoadingMsg('üß† Gemini is analysing "' + topic + '"‚Ä¶');
            const explainResp = await fetch('/api/topic-resolver/explain', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ topic })
            });
            const explainData = await explainResp.json();
            if (!explainResp.ok) throw new Error(explainData.error || 'Explanation failed');
            renderExplanation(explainData, topic);

            // Step 2: YouTube Videos (parallel with diagram)
            setLoadingMsg('üé• Finding best YouTube videos‚Ä¶');
            const [videosResp, diagramResp] = await Promise.all([
                fetch('/api/topic-resolver/videos', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ topic, search_query: explainData.youtube_query || topic })
                }),
                fetch('/api/topic-resolver/diagram', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ topic, description: explainData.summary || topic })
                })
            ]);

            const videosData = await videosResp.json();
            renderVideos(videosData.videos || []);

            const diagramData = await diagramResp.json();
            renderDiagram(diagramData);

            // Show results
            showSection('results');

            // Award XP
            awardXP();

        } catch (err) {
            showSection('error');
            document.getElementById('errorMsg').textContent = err.message || 'Something went wrong. Please try again.';
        } finally {
            document.getElementById('resolveBtn').disabled = false;
        }
    }

    /* ‚îÄ‚îÄ UI Sections ‚îÄ‚îÄ */
    function showSection(which) {
        document.getElementById('loadingState').className = 'loading-state' + (which === 'loading' ? ' active' : '');
        document.getElementById('resultsArea').className = 'results-area' + (which === 'results' ? ' active' : '');
        document.getElementById('errorState').className = 'error-state' + (which === 'error' ? ' active' : '');
    }

    function setLoadingMsg(msg) {
        document.getElementById('loadingMsg').textContent = msg;
    }

    /* ‚îÄ‚îÄ Render Explanation ‚îÄ‚îÄ */
    function renderExplanation(data, topic) {
        document.getElementById('result-topic-title').textContent = topic;
        document.getElementById('result-topic-sub').textContent = data.subtitle || 'AI-powered deep dive ‚Ä¢ YouTube curated videos ‚Ä¢ Visual diagram';
        document.getElementById('explainTime').textContent = 'Generated just now';

        // Main text
        document.getElementById('explanationText').innerHTML =
            (data.explanation || '').replace(/\n/g, '<br>');

        // Key points
        const kpEl = document.getElementById('keyPoints');
        kpEl.innerHTML = '';
        if (data.key_points && data.key_points.length) {
            data.key_points.forEach(pt => {
                kpEl.innerHTML += `
          <div class="key-point">
            <i class="fa-solid fa-circle-check kp-icon"></i>
            <span>${escHtml(pt)}</span>
          </div>`;
            });
        }

        // Common mistakes
        if (data.common_mistakes) {
            document.getElementById('mistakesBox').style.display = '';
            document.getElementById('mistakesText').textContent = data.common_mistakes;
        }
        // Memory trick
        if (data.memory_trick) {
            document.getElementById('memoryTrick').style.display = '';
            document.getElementById('memoryText').textContent = data.memory_trick;
        }
    }

    /* ‚îÄ‚îÄ Render Videos ‚îÄ‚îÄ */
    function renderVideos(videos) {
        const el = document.getElementById('videosList');
        document.getElementById('videoCount').textContent = videos.length + ' videos';
        if (!videos.length) {
            el.innerHTML = `<div class="no-videos-msg"><i class="fa-brands fa-youtube"></i> No videos found. Try a different topic.</div>`;
            return;
        }
        el.innerHTML = videos.map(v => `
      <a class="video-card" href="https://www.youtube.com/watch?v=${escHtml(v.id)}" target="_blank" rel="noopener">
        <img class="video-thumb" src="${escHtml(v.thumbnail)}" alt="${escHtml(v.title)}" onerror="this.src='https://via.placeholder.com/100x60/1a1a2e/a78bfa?text=?'" loading="lazy">
        <div class="video-info">
          <div class="video-title">${escHtml(v.title)}</div>
          <div class="video-meta">
            <span class="video-channel">${escHtml(v.channel)}</span>
            ${v.duration ? `<span class="video-duration"><i class="fa-regular fa-clock"></i> ${escHtml(v.duration)}</span>` : ''}
            ${v.views ? `<span class="video-views"><i class="fa-solid fa-eye"></i> ${escHtml(v.views)}</span>` : ''}
          </div>
        </div>
        <span class="yt-badge"><i class="fa-brands fa-youtube"></i> Watch</span>
      </a>
    `).join('');
    }

    /* ‚îÄ‚îÄ Render Diagram ‚îÄ‚îÄ */
    function renderDiagram(data) {
        const wrap = document.getElementById('diagramWrap');
        const actions = document.getElementById('diagramActions');
        const status = document.getElementById('diagramStatus');

        if (data.image_url) {
            currentDiagramUrl = data.image_url;
            status.textContent = 'AI Generated ‚Ä¢ Click to zoom';
            wrap.innerHTML = `<img class="diagram-img" src="${escHtml(data.image_url)}" alt="AI Diagram" onclick="zoomDiagram(this.src)" onerror="this.parentNode.innerHTML='<div class=\\'diagram-placeholder\\'><i class=\\'fa-solid fa-image\\'></i>Diagram generation is unavailable right now. Try again.</div>'">`;
            actions.style.display = 'flex';
        } else if (data.description) {
            // Fallback: show text description in a styled box
            status.textContent = 'Text diagram (image unavailable)';
            wrap.innerHTML = `
        <div style="background:rgba(167,139,250,0.06); border:1px solid rgba(167,139,250,0.2); border-radius:12px; padding:16px; text-align:left; color:var(--text-secondary); font-size:13px; line-height:1.8; white-space:pre-wrap;">${escHtml(data.description)}</div>`;
            actions.style.display = 'none';
        } else {
            wrap.innerHTML = `<div class="diagram-placeholder"><i class="fa-solid fa-image"></i>Diagram could not be generated for this topic. Try rephrasing.</div>`;
            actions.style.display = 'none';
        }
    }

    function zoomDiagram(src) {
        document.getElementById('lightboxImg').src = src;
        document.getElementById('lightbox').classList.add('open');
    }

    function downloadDiagram() {
        if (!currentDiagramUrl) return;
        const a = document.createElement('a');
        a.href = currentDiagramUrl;
        a.download = currentTopic.replace(/\s+/g, '_') + '_diagram.jpg';
        a.target = '_blank';
        a.click();
    }

    async function regenerateDiagram() {
        if (!currentTopic) return;
        document.getElementById('diagramWrap').innerHTML = `
      <div class="generating-img">
        <i class="fa-solid fa-rotate fa-spin" style="font-size:24px; color:#a78bfa;"></i>
        <span style="font-size:13px;">Regenerating diagram‚Ä¶</span>
      </div>`;
        document.getElementById('diagramActions').style.display = 'none';
        const resp = await fetch('/api/topic-resolver/diagram', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ topic: currentTopic, description: currentTopic })
        });
        const data = await resp.json();
        renderDiagram(data);
    }

    /* ‚îÄ‚îÄ XP Award ‚îÄ‚îÄ */
    function awardXP() {
        fetch('/api/topic-resolver/award-xp', { method: 'POST' })
            .then(r => r.json())
            .then(d => {
                if (d.earned > 0) {
                    const badge = document.getElementById('xpBadge');
                    badge.textContent = '+' + d.earned + ' XP Earned';
                    badge.innerHTML = '<i class="fa-solid fa-star"></i> +' + d.earned + ' XP Earned';
                    badge.style.display = 'inline-flex';
                }
            }).catch(() => { });
    }

    function escHtml(s) {
        if (!s) return '';
        const d = document.createElement('div');
        d.appendChild(document.createTextNode(String(s)));
        return d.innerHTML;
    }
</script>
{% endblock %}